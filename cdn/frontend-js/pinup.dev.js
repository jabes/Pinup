/***

  Pinup JavaScript
  http://www.jbull.ca/work/pinup
  @copyright: Copyright (c) 2012 Pinup. All rights reserved.
  @license: Dual licensed under the MIT or GPL Version 2 licenses.
  @version: 2.02-debug-live
  @date: 2012-12-18

***/
(function(window){var exist=false,alive=false,globalVars={},globalElements={},globalKeyEvents={},cacheImages={},cacheNodes={},cacheTags={},cacheTagData={},cacheEvents={},cacheElements={},queueTagData={},jsonpHandler={},jsonpTimeout={},userInfo={},userHash,userLogged=false,support={},hiddenImages={},stats={},plib,pfunc,defaultSettings,settings,classes,directory,regex,messages,attributes,names,types,events,html,commonHTML,layout,css,serverKeys,document=window.document,protoString=Object.prototype.toString,
windowLocation=window.location.href,defaultView=document.defaultView,consoleObject=window.console,consoleMethods=["log","info","warn","error","time","timeEnd"],cssPrefix="PIN_",tagPrefix="tagId_",sysName="Pinup",ieEventPrefix="on",cssUnit="px",monetarySymbol="$",whiteSpace=" ",asterisk="*",ellipsis="...",webProtos=["http://","https://"],defaultWebProto=webProtos[0],oNamespace={root:sysName,json:"jsonpHandler",globalVars:"globalVars",settings:"settings",defaultSettings:"defaultSettings",user:"user",
lib:"lib",fn:"fn",images:"images",nodes:"nodes",tags:"tags",events:"events",elements:"elements",checkSite:"checkSite-",checkImage:"checkImage-",vmlCanvas:"G_vmlCanvasManager"},opacities={full:1,semi:0.3},keyCodes={f2:113,esc:27,enter:13,arrowLeft:37,arrowRight:39},splElmIds={"window":"GUID-window","document":"GUID-document"},strBool={1:"yes","0":"no"},readyStates={complete:"complete",loaded:"loaded"},NULL_TYPE="null",UNDEFINED_TYPE="undefined",BOOLEAN_TYPE="boolean",NUMBER_TYPE="number",STRING_TYPE=
"string",OBJECT_TYPE="object",ARRAY_TYPE="array",FUNCTION_TYPE="function",ELEMENT_TYPE="element",DATE_TYPE="date",BOOLEAN_CLASS="[object Boolean]",NUMBER_CLASS="[object Number]",STRING_CLASS="[object String]",ARRAY_CLASS="[object Array]",FUNCTION_CLASS="[object Function]",DATE_CLASS="[object Date]",nLastLoginCheck=0,scrollMem;directory={names:{getTags:"get_tags",getTagSugg:"get_tag_suggestion",register:"register",login:"login",logout:"logout",forgot:"forgot_pass",checkLogin:"check_login",checkImage:"check_image",
checkSite:"get_site_settings",tagCreate:"tag_create",tagPosition:"tag_position",tagRemove:"tag_remove",logTagHover:"log_tag_hover"},paths:{twitter:"http://twitter.com/intent/tweet?",facebook:"https://www.facebook.com/sharer.php?",gateway:"http://www.jbull.ca/work/pinup/gateway/",cdn:"http://www.jbull.ca/work/pinup/cdn/",website:"http://www.jbull.ca/work/pinup/"}};directory.paths.webloc=directory.paths.gateway+"webloc.php?u=";directory.paths.hub=directory.paths.gateway+"hub.php";
directory.paths.themes=directory.paths.cdn+"frontend-themes/css/";directory.paths.excanvas=directory.paths.cdn+"global-js/excanvas.js";defaultSettings={nMinWidth:250,nMinHeight:200,jsonpTimeout:3E4,scrollDelay:300,navAniSpeed:250,loadImages:[],loadAll:false,smartLoad:true,forceListen:false,alwaysShowTags:true,cssHelper:true,posHelper:true,animations:true,keyListener:true,onReady:function(){},onLogout:function(){},onLogin:function(){},themeFile:"",allowFile:"jpg|jpeg|png",allowThemeManager:false,allowLocalStorage:false,
allowBottomLinks:false,allowShare:true,dotSize:"medium",dotOutlineSize:6,canvas:{cornerRadius:5,tailWidth:19,tailHeight:8,stroke:false,shadow:true,theme:{backgroundStyle:"radial",backgroundColor:"0-#FFFFFF 1-#CCCCCC",strokeWidth:1,strokeColor:"#000000",shadowOffsetX:0,shadowOffsetY:0,shadowBlur:5,shadowColor:"#000000"}},tooltip:true,tooltipOrientation:"top",tooltipURL:true,altImageSrc:"pinsrc",activeParentClass:"allpins",activeChildClass:"pinimg",custom:{}};classes={docBody:cssPrefix+"active",noAnimation:cssPrefix+
"noAnimation",noRgbaSupport:cssPrefix+"noRgbaSupport",noBoxShadowSupport:cssPrefix+"noBoxShadowSupport",noBorderRadiusSupport:cssPrefix+"noBorderRadiusSupport",wrapper:cssPrefix+"wrapper",lightbox:cssPrefix+"lightbox",lightboxWindow:cssPrefix+"lightboxWindow",lightboxOverlay:cssPrefix+"lightboxOverlay",lightboxImage:cssPrefix+"lightboxImage",lightboxImageHolder:cssPrefix+"lightboxImageHolder",lightboxNav:cssPrefix+"lightboxNav",lightboxShowLeft:cssPrefix+"lightboxShowLeft",lightboxShowRight:cssPrefix+
"lightboxShowRight",lightboxNavIcon:cssPrefix+"lightboxNavIcon",node:cssPrefix+"node",inlineNode:cssPrefix+"inlineNode",sectionBody:cssPrefix+"sectionBody",sectionFooter:cssPrefix+"sectionFooter",image:cssPrefix+"image",overlay:cssPrefix+"overlay",logo:cssPrefix+"logo",button:cssPrefix+"button",lastItem:cssPrefix+"lastItem",noSelect:cssPrefix+"noSelect",handOver:cssPrefix+"handOver",handDrag:cssPrefix+"handDrag",iconLabel:cssPrefix+"iconLabel",guiLeftHolder:cssPrefix+"guiLeftHolder",guiRightHolder:cssPrefix+
"guiRightHolder",guiBotL:cssPrefix+"btnBotL",guiTopR:cssPrefix+"btnTopR",btnCancel:cssPrefix+"btnCancel",btnSettings:cssPrefix+"btnSettings",btnAddnew:cssPrefix+"btnAddTag",window:cssPrefix+"window",windowOverlay:cssPrefix+"windowOverlay",windowBackground:cssPrefix+"windowBackground",windowClose:cssPrefix+"windowBtnClose",windowBody:cssPrefix+"windowBody",windowLogout:cssPrefix+"windowLogout",windowUserName:cssPrefix+"windowUserName",windowHeader:cssPrefix+"header",windowTitle:cssPrefix+"title",prompt:cssPrefix+
"prompt",promptMessage:cssPrefix+"promptMessage",promptAccept:cssPrefix+"promptAccept",promptDeny:cssPrefix+"promptDeny",modalMsg:cssPrefix+"modalMsg",focus:cssPrefix+"focus",formStyle:cssPrefix+"formStyle",formError:cssPrefix+"formError",formDisabledMsg:cssPrefix+"formDisabledMsg",formErrorRow:cssPrefix+"formErrorRow",formLabel:cssPrefix+"formLabel",formLabelSm:cssPrefix+"formLabel-sm",formTextField:cssPrefix+"textField",formTextArea:cssPrefix+"textArea",formDropDown:cssPrefix+"dropDown",formDropDownDiv:cssPrefix+
"dropDownDiv",formBtnSubmit:cssPrefix+"formBtnSubmit",formBtnLeft:cssPrefix+"formBtnLeft",formOptions:cssPrefix+"options",formOption_forgotPass:cssPrefix+"optForgotPass",formOption_backToLogin:cssPrefix+"optBackToLogin",formOption_register:cssPrefix+"optRegister",tag:cssPrefix+"tag",tagSmall:cssPrefix+"tagSmall",tagMedium:cssPrefix+"tagMedium",tagLarge:cssPrefix+"tagLarge",tagHolder:cssPrefix+"tagHolder",tagDot:cssPrefix+"tagDot",tagOutline:cssPrefix+"tagOutline",tagBubble:cssPrefix+"tagBubble",tagBubbleContent:cssPrefix+
"tagBubbleContent",tagBubbleCanvas:cssPrefix+"tagBubbleCanvas",tagBubbleButton:cssPrefix+"tagBubbleButton",tagLink:cssPrefix+"tagLink",tagLinkText:cssPrefix+"tagLinkText",tagLinkURL:cssPrefix+"tagLinkURL",tagLinkLike:cssPrefix+"tagLinkLike",tagDirLeft:cssPrefix+"tagDirL",tagDirRight:cssPrefix+"tagDirR",link:cssPrefix+"link",linkHolder:cssPrefix+"linkHolder",linkHolderBackground:cssPrefix+"linkHolderBackground",linkPending:cssPrefix+"linkPending",shareHolder:cssPrefix+"shareHolder",shareHeader:cssPrefix+
"shareHeader",shareButtons:cssPrefix+"shareButtons",shareButton:cssPrefix+"shareButton",actionOn:cssPrefix+"on",actionShowWin:cssPrefix+"showWin",taggingMode:cssPrefix+"taggingMode",repositionMode:cssPrefix+"repositionMode",removalMode:cssPrefix+"removalMode"};messages={noImages:sysName+": No images have been found",imageLoaded:sysName+": Image has loaded: %o",imageUnloaded:sysName+": Image has been unloaded: %s",imageNewSrc:sysName+': Image src "%s" was replaced with: "%s"',imageCount:sysName+": We found %i images; %i of those have been loaded and %i of those have been denied",
sysDestroyed:sysName+": All instances have been removed",themeLoaded:sysName+': The theme "%s" has loaded',excanvasRequest:sysName+": Excanvas has been requested",excanvasReceived:sysName+": Excanvas has been loaded then initialized and canvas is %s",noPubKey:sysName+": Public key was not provided",alreadyAlive:sysName+": System already active",alreadyDead:sysName+": System does not exist",badInstance:sysName+": Image already contains a valid identifier",noInstance:sysName+": Image does not contain a valid identifier",
badTarget:sysName+": Event target is undefined",noImage:sysName+": Aborted due to faulty or non-existant image reference",inBlacklist:sysName+": Image was rejected because it was found in the blacklist %o",imageTooSmall:sysName+": Image was rejected because it did not meet the minimum size requirements: width(%spx/%spx) and height(%spx/%spx) %o",imageNoSrc:sysName+": Image was rejected because it does not have a file source %o",imageBadFile:sysName+': Image was rejected because of an unknown file type "%s" on %o',
imageNotFound:sysName+": Image has been removed from the document and will no longer be able to load %o",imageIgnoreSEO:sysName+": Image was rejected because it appears to be a SEO pseudo tag %o",sysNotActive:sysName+": Requested action not performed because the system is not active",eventDuplicate:sysName+': Ignored duplicate event type "%s" on %o',settingDNF:sysName+': Custom setting "%s" was not found',badType:sysName+': Custom setting "%s" was ignored because of mismatched type (expected %s but found %s)',
themeNotFound:sysName+': The theme "%s" was not found. The default theme was loaded',jsonp:sysName+": JSONP CALL: %s",serverSet:sysName+": Settings from server: %o",instOutput:sysName+": Instance done: %o",jsonpTimeout:sysName+": JSONP call has timed out on script: %s",sysLoadTime:sysName+": Load Time",noResults:"No results found.",loading:"Loading"+ellipsis,leftNavWait:"THINKING"+ellipsis,formWait:"PLEASE WAIT"+ellipsis,removeTag:"Are you sure you wish to permanently delete this tag?",removeMultiTags:"Are you sure you wish to permanently delete this tag? Caution: There are multiple links associated with this tag.",
missingReqInput:"A REQUIRED FIELD IS EMPTY",invalidEmail:"EMAIL ADDRESS IS NOT VALID"};css={display:"display",margin:{top:"marginTop",right:"marginRight",bottom:"marginBottom",left:"marginLeft"},padding:{top:"paddingTop",right:"paddingRight",bottom:"paddingBottom",left:"paddingLeft"},width:"width",height:"height",maxWidth:"maxWidth",maxHeight:"maxHeight",top:"top",right:"right",bottom:"bottom",left:"left",visibility:"visibility",opacity:"opacity",filter:"filter",zIndex:"zIndex",cssFloat:"float",position:"position"};
attributes={id:"id",className:"class",style:"style",src:"src",href:"href",rel:"rel",name:"name",type:"type",width:"width",height:"height",align:"align",hspace:"hspace",vspace:"vspace",unselectable:"unselectable",disabled:"disabled",readonly:"readonly",selected:"selected",autoComplete:"autocomplete",tagGuid:"taguid",tagMultiGuid:"taguids",tagName:"tagname",tagKeywords:"keywords",tagWebLink:"weblink",tagPosX:"posx",tagPosY:"posy",tagOwnerId:"ownerid",fluidWidth:"fluidwidth",hiddenKey:"hiddenkey",imgLoaded:"loaded",
orgText:"orgtext",isVisible:"isvis",guid:"guid"};names={formRegister:cssPrefix+"registerForm",formLogin:cssPrefix+"loginForm",formForgot:cssPrefix+"formForgot",formCreate:cssPrefix+"newTagForm",formSettings:cssPrefix+"formSettings",strFullName:"strFullName",strUsername:"strUsername",strPassword:"strPassword",strConfirmPass:"strConfirmPass",strWebName:"strWebName",strWebURL:"strWebURL",nTagID:"nTagID",strWebReferer:"strWebReferer",strImageURL:"strImageURL",strTagName:"strTagName",strKeywords:"strKeywords",
strWebLink:"strWebLink",nPosX:"nPosX",nPosY:"nPosY",strComments:"strComments",btnRepositionTags:"btnRepositionTags",btnRemoveTags:"btnRemoveTags",btnOpenLightbox:"btnOpenLightbox"};types={button:"button",submit:"submit",text:"text",password:"password",hidden:"hidden",jstxt:"text/javascript",csstxt:"text/css"};events={submit:"submit",scroll:"scroll",click:"click",load:"load",unload:"unload",keyup:"keyup",focus:"focus",blur:"blur",change:"change",mouseover:"mouseover",mouseout:"mouseout",mousedown:"mousedown",
mouseup:"mouseup",mousemove:"mousemove",selectstart:"selectstart",readystatechange:"readystatechange",domcontentloaded:"domcontentloaded"};html={script:"script",link:"link",head:"head",body:"body",h2:"h2",p:"p",a:"a",br:"br",em:"em",ol:"ol",li:"li",strong:"strong",img:"img",div:"div",span:"span",form:"form",input:"input",select:"select",option:"option",textarea:"textarea",label:"label",button:"button",canvas:"canvas"};serverKeys={user:{guid:"guid",tagTotal:"tagTotal",fullName:"fullName",isOwner:"isOwner"},
tags:{guid:"strGUID",name:"strTagName",imagePath:"strImageURL",posX:"nPosX",posY:"nPosY",keywords:"arrKeywords",webLink:"strWebLink",ownerGuid:"nTaggerAccountsID"}};regex={csv:/[\s,]+/,ss:/\s/g,ltrim:/^\s\s*/,rtrim:/\s\s*$/,purl:/^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@]*):?([^:@]*))?@)?([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)/,query:/(?:^|&)([^&=]*)=?([^&]*)/g,nump:/[^0-9\.\-]+/g,camel:/-+(.) ?/g,tslash:/\/$/g,fext:/[^.]+$/,opacity:/^0.55$/};globalVars.availableThemes=
{"default":825248,"launch":469725,"virgin":979253};globalVars.availableDotSizes={"small":classes.tagSmall,"medium":classes.tagMedium,"large":classes.tagLarge};globalVars.tooltipOrientations={top:"top",right:"right",bottom:"bottom",left:"left"};globalVars.canvasDrawStyles={radial:"radial",linear:"linear",solid:"solid"};plib={onDomReady:function(fn){var listenType=document.addEventListener?events.domcontentloaded:events.readystatechange,unload=function(){plib.removeEvent(document,listenType);plib.removeEvent(window,
events.load)};if(document.readyState!==readyStates.complete){plib.addEvent(document,listenType,function(){if(document.readyState===readyStates.complete){unload.call();fn.call()}});plib.addEvent(window,events.load,function(){unload.call();fn.call()})}else fn.call()},loadScript:function(url,callback){var script,properties={},unload=function(){plib.removeEvent(script,events.readystatechange);plib.removeEvent(script,events.load)};properties[attributes.src]=url;properties[attributes.type]=types.jstxt;
script=plib.domAppend(html.script,document.getElementsByTagName(html.head)[0],properties);plib.addEvent(script,events.readystatechange,function(){if(script.readyState===readyStates.complete||script.readyState===readyStates.loaded){unload.call();callback(script)}});plib.addEvent(script,events.load,function(){unload.call();callback(script)})},type:function(o){switch(o){case null:return NULL_TYPE;case void 0:return UNDEFINED_TYPE}var proto=protoString.call(o);switch(proto){case BOOLEAN_CLASS:return BOOLEAN_TYPE;
case NUMBER_CLASS:return NUMBER_TYPE;case STRING_CLASS:return STRING_TYPE;case ARRAY_CLASS:return ARRAY_TYPE;case FUNCTION_CLASS:return FUNCTION_TYPE;case DATE_CLASS:return DATE_TYPE}if(o.nodeType===1)return ELEMENT_TYPE;return OBJECT_TYPE},isElement:function(e){return plib.type(e)===ELEMENT_TYPE},isNull:function(e){return plib.type(e)===NULL_TYPE},isUndefined:function(e){return plib.type(e)===UNDEFINED_TYPE},isBoolean:function(e){return plib.type(e)===BOOLEAN_TYPE},isNumber:function(e){return plib.type(e)===
NUMBER_TYPE},isString:function(e){return plib.type(e)===STRING_TYPE},isObject:function(e){return plib.type(e)===OBJECT_TYPE},isFunction:function(e){return plib.type(e)===FUNCTION_TYPE},isArray:function(e){return plib.type(e)===ARRAY_TYPE},isNumeric:function(n){return!isNaN(parseFloat(n))&&isFinite(n)},hasClass:function(element,s){return(new RegExp("\\b"+s+"\\b")).test(element.className)},addClass:function(element,s){if(!plib.hasClass(element,s))element.className+=element.className?whiteSpace+s:s},
removeClass:function(element,s){var rep=element.className.match(whiteSpace+s)?whiteSpace+s:s;element.className=element.className.replace(rep,"")},getParentByClassName:function(element,s){while(element&&!plib.hasClass(element,s))element=element.parentNode||null;return element},getElementsByClassName:function(s,node){var output=[];node=node||document.getElementsByTagName(html.body).item(0);plib.loopArray(node.getElementsByTagName(asterisk),function(value){if(plib.hasClass(value,s))output.push(value)});
return output},hasProperty:function(object,property){var hasOwn=Object.prototype.hasOwnProperty,proto="__proto__";if(hasOwn)return hasOwn.call(object,property);else{proto=object[proto]||object.constructor.prototype;return!plib.isUndefined(object[property])&&(plib.isUndefined(proto[property])||proto[property]!==object[property])}},loop:function(len,callback){var i=0;while(i<len){if(callback(i)===null)break;i++}},rloop:function(len,func){while(len--)func(len)},loopArray:function(array,callback){plib.loop(array.length,
function(index){return callback.length===2?callback(index,array[index]):callback(array[index])})},loopObject:function(object,callback){var property;for(property in object)if(callback.length===1){if(callback(object[property])===null)break}else if(callback.length===2)if(callback(property,object[property])===null)break},loopObjectKeys:function(object,callback){var property;for(property in object)if(callback(property)===null)break},isObjectEmpty:function(object){var property;for(property in object)if(plib.hasProperty(object,
property))return false;return true},mergeObject:function(object1,object2){var property;for(property in object2)object1[property]=object2[property];return object1},cloneObject:function(object){var clone={};if(!plib.isObject(object))return object;plib.loopObject(object,function(key,val){clone[key]=plib.cloneObject(val)});return clone},getParamsFromObject:function(object){var s=[];plib.loopObject(object,function(key,val){s[s.length]=encodeURIComponent(key)+"="+encodeURIComponent(val)});return s.join("&")},
getEventTarget:function(event){var target;event=event||window.event;target=event.target||event.srcElement;if(target.nodeType===3)target=target.parentNode;return target},randomID:function(size){var str="",i=0,chars="0123456789ABCDEFGHIJKLMNOPQURSTUVWXYZ";while(i<size){str+=chars.substr(Math.floor(Math.random()*chars.length),1);i++}return str},getMousePosition:function(event){event=event||window.event;var de=document.documentElement,b=document.body,cursor={x:0,y:0};if(event.pageX||event.pageY){cursor.x=
event.pageX;cursor.y=event.pageY}else{cursor.x=event.clientX+(de.scrollLeft||b.scrollLeft)-de.clientLeft;cursor.y=event.clientY+(de.scrollTop||b.scrollTop)-de.clientTop}return cursor},getWidth:function(element){var width=element.offsetWidth||element.clientWidth;if(!width){plib.setStyle(element,css.visibility,"hidden");plib.show(element);width=element.offsetWidth||element.clientWidth;plib.hide(element);plib.setStyle(element,css.visibility,"visible")}return width||0},setWidth:function(element,value){plib.setStyle(element,
css.width,value)},getHeight:function(element){var height=element.offsetHeight||element.clientHeight;if(!height){plib.setStyle(element,css.visibility,"hidden");plib.show(element);height=element.offsetHeight||element.clientHeight;plib.hide(element);plib.setStyle(element,css.visibility,"visible")}return height||0},setHeight:function(element,value){plib.setStyle(element,css.height,value)},getCumulativeOffset:function(element){var offset={x:0,y:0};if(element.offsetParent){do{offset.x+=element.offsetLeft;
offset.y+=element.offsetTop;element=element.offsetParent}while(element)}return offset},attribute:function(element,name,value){var nType=element.nodeType;if(!element||nType===3||nType===8||nType===2)return undefined;else if(plib.isObject(name))plib.loopObject(name,function(key,val){plib.attribute(element,key,val)});else if(!plib.isUndefined(value))if(value===null||value===false){if(name==="class")plib.removeClass(element,value);else element.removeAttribute(name);return undefined}else{if(name==="class")plib.addClass(element,
value);else element.setAttribute(name,value);return value}else return element.getAttribute(name)},getGUID:function(element){var guid;if(element===window)guid=splElmIds.window;else if(element===document)guid=splElmIds.document;else{guid=plib.attribute(element,attributes.guid);if(!guid)guid=plib.attribute(element,attributes.guid,plib.randomID(16))}return guid},setStyles:function(element,object){plib.loopObject(object,function(key,val){plib.setStyle(element,key,val)})},setStyle:function(element,prop,
value){var style=element.style;prop=prop===css.cssFloat?support.cssFloat:prop;if(!style||!element||element.nodeType===3||element.nodeType===8)return;if(prop===css.opacity){plib.setAlpha(element,value);return}if(plib.isNumber(value)&&!plib.inArray([css.zIndex,css.opacity],prop))value+=cssUnit;pfunc.attempt(function(){style[prop]=value})},getStyle:function(element,prop,computedStyles){var value,filter;if(plib.isString(element)){computedStyles=prop;prop=element;element=undefined}if(prop===css.opacity&&
!support.opacity){filter=plib.getStyle(element,css.filter,computedStyles);value=filter?parseFloat(filter.replace(regex.nump,""))/100:null}else{computedStyles=computedStyles||plib.getComputedStyles(element);value=computedStyles[prop]}return value==="auto"?null:value},getComputedStyles:function(element){var styles={},computedStyles=defaultView?defaultView.getComputedStyle(element,null):element.currentStyle,stylesLength=computedStyles.length,addStyle=function(cssProperty){var cssValue,cssType,parsedValue;
if(!plib.isUndefined(computedStyles.getPropertyValue))cssValue=computedStyles.getPropertyValue(cssProperty);if(!cssValue)cssValue=computedStyles[cssProperty];if(cssValue){cssType=plib.type(cssValue);if(plib.isNumeric(cssValue)&&cssType!==NUMBER_TYPE||cssType===STRING_TYPE&&cssValue.indexOf(cssUnit)>0){parsedValue=parseFloat(cssValue);if(!isNaN(parsedValue))cssValue=parsedValue}styles[plib.camelize(cssProperty)]=cssValue}};if(stylesLength)plib.loop(stylesLength,function(i){addStyle(computedStyles[i])});
else plib.loopObjectKeys(computedStyles,function(key){if(plib.hasProperty(computedStyles,key))addStyle(key)});return styles},camelize:function(str){return str.replace(regex.camel,function(match,chr){return chr?chr.toUpperCase():""})},stopBubble:function(event){event=event||window.event;if(event.preventDefault)event.preventDefault();else event.returnValue=false;if(event.stopPropagation)event.stopPropagation();else event.cancelBubble=true},removeChildren:function(element){if(element)while(element.hasChildNodes())plib.removeElement(element.firstChild)},
cleanElement:function(element){var guid=plib.getGUID(element);plib.removeAllEvents(element);plib.removeChildren(element);pfunc.removeAllKeyListeners(guid);delete cacheElements[guid]},removeElement:function(element){if(element){plib.cleanElement(element);if(element.parentNode)element.parentNode.removeChild(element)}},replaceElement:function(elm1,elm2){plib.cleanElement(elm1);if(plib.isString(elm2))elm2=document.createTextNode(elm2);if(elm1.parentNode)elm1.parentNode.replaceChild(elm2,elm1)},insertBefore:function(elm1,
elm2){elm1.parentNode.insertBefore(elm2,elm1);return elm2},insertAfter:function(elm1,elm2){if(plib.isString(elm2))elm2=document.createTextNode(elm2);elm1.parentNode.insertBefore(elm2,plib.getNextSibling(elm1));return elm2},getNextSibling:function(element){do element=element.nextSibling;while(element&&element.nodeType!==1);return element},newElement:function(strType,objAttributes,textNode){var newElm=document.createElement(strType),guid=plib.getGUID(newElm);cacheElements[guid]=newElm;if(objAttributes&&
plib.isString(objAttributes)){textNode=textNode||objAttributes;objAttributes={}}if(objAttributes&&plib.isObject(objAttributes))plib.attribute(newElm,objAttributes);if(textNode&&plib.isString(textNode))plib.appendText(newElm,textNode);return newElm},domAppend:function(element,elmAppendTo,objAttributes,textNode){var nt1,nt2;if(objAttributes&&plib.isString(objAttributes)){textNode=textNode||objAttributes;objAttributes={}}if(plib.isString(element))element=plib.newElement(element,objAttributes,textNode);
nt1=element.nodeType;nt2=elmAppendTo.nodeType;if((nt1===1||nt1===11||nt1===3)&&(nt2===1||nt2===11||nt2===3))elmAppendTo.appendChild(element);return element},domWrap:function(elmWrapper,elmInner,objAttributes,textNode){if(objAttributes&&plib.isString(objAttributes)){textNode=textNode||objAttributes;objAttributes={}}if(plib.isString(elmWrapper))elmWrapper=plib.newElement(elmWrapper,objAttributes,textNode);if(plib.isElement(elmWrapper)&&plib.isElement(elmInner)){elmInner.parentNode.insertBefore(elmWrapper,
elmInner);plib.domAppend(elmInner,elmWrapper)}return elmWrapper},isElementIn:function(element,compare){while(element){if(element===compare||element.nodeName.toLowerCase()===compare)return true;element=element.parentNode}return false},isElementEmpty:function(element){return element.children.length===0},parseHTML:function(jsonHtml,lang){var documentFragment=document.createDocumentFragment(),buildElement;buildElement=function(objNodeData){var oAttributes={},elmNode;if(plib.hasProperty(objNodeData,lang.id))oAttributes.id=
objNodeData[lang.id];if(plib.hasProperty(objNodeData,lang.className))oAttributes["class"]=objNodeData[lang.className];if(plib.hasProperty(objNodeData,lang.attr))plib.loopObject(objNodeData[lang.attr],function(key,val){oAttributes[key]=val});if(plib.hasProperty(objNodeData,lang.nodeName)){elmNode=plib.newElement(objNodeData[lang.nodeName],oAttributes);if(objNodeData[lang.childNodes]&&objNodeData[lang.childNodes].length>0)plib.loopArray(objNodeData[lang.childNodes],function(value){plib.domAppend(buildElement(value),
elmNode)})}if(objNodeData[lang.text]&&objNodeData[lang.text].length>0)if(elmNode)plib.appendText(elmNode,objNodeData[lang.text]);else elmNode=document.createTextNode(objNodeData[lang.text]);return elmNode};lang=lang||{nodeName:"nodeName",childNodes:"childNodes",className:"className",id:"id",attr:"attr",text:"text"};if(plib.isArray(jsonHtml))plib.loopArray(jsonHtml,function(value){plib.domAppend(buildElement(value),documentFragment)});else if(plib.isObject(jsonHtml))plib.domAppend(buildElement(jsonHtml),
documentFragment);return documentFragment},replaceHTML:function(element,html){plib.removeChildren(element);if(plib.isString(html))plib.appendText(element,html);else element.appendChild(plib.parseHTML(html))},appendText:function(element,string){if(string.length>0)return element.appendChild(document.createTextNode(string))},textContentRecursive:function(element,string){while(element){if(!element.firstChild||!plib.isElement(element.firstChild))if(string)return plib.textContent(element,string);else return plib.textContent(element);
element=element.firstChild}},textContent:function(element,string){var i,j,child;for(i=0,j=element.childNodes.length;i<j;i++){child=element.childNodes[i];if(child.nodeType===3){if(string)child.nodeValue=string;return child.nodeValue}}return string?plib.appendText(element,string):""},disableSelection:function(element){if(!plib.isUndefined(element.onselectstart))element.onselectstart=function(){return false};plib.addClass(element,classes.noSelect);plib.attribute(element,attributes.unselectable,"on")},
show:function(element){element.style[css.display]="block"},hide:function(element){element.style[css.display]="none"},isVisible:function(element){var computedStyles=plib.getComputedStyles(element);return!(plib.getStyle(css.visibility,computedStyles)==="hidden"||plib.getStyle(css.display,computedStyles)==="none"||plib.getStyle(css.opacity,computedStyles)===0)},handleEvent:function(event){event=event||window.event;plib.stopBubble(event);var element=this,returnValue=true,handlers=element.events[event.type];
plib.loopObjectKeys(handlers,function(key){element.handleEvent=handlers[key];if(element.handleEvent(event)===false)returnValue=false});return returnValue},hasEvent:function(element,eventType){var guid=plib.getGUID(element);return!!(cacheEvents[guid]&&cacheEvents[guid][eventType])},addEvent:function(element,eventType,handler){var guid=plib.getGUID(element),handlers;if(plib.hasEvent(element,eventType)){pfunc.warn(messages.eventDuplicate,eventType,element);return}if(!cacheEvents[guid])cacheEvents[guid]=
{};cacheEvents[guid][eventType]={"element":element,"handler":handler};if(element.addEventListener)element.addEventListener(eventType,handler,false);else{if(!handler.guid)handler.guid=plib.randomID(12);if(!element.events)element.events={};handlers=element.events[eventType];if(!handlers){handlers=element.events[eventType]={};if(element[ieEventPrefix+eventType])handlers[0]=element[ieEventPrefix+eventType]}handlers[handler.guid]=handler;element[ieEventPrefix+eventType]=plib.handleEvent}},removeEvent:function(element,
eventType){var guid=plib.getGUID(element),handler;if(plib.hasEvent(element,eventType)){handler=cacheEvents[guid][eventType].handler;delete cacheEvents[guid][eventType];if(plib.isObjectEmpty(cacheEvents[guid]))delete cacheEvents[guid];if(element.removeEventListener)element.removeEventListener(eventType,handler,false);else if(element.events&&element.events[eventType])delete element.events[eventType][handler.guid]}},removeAllEvents:function(element){var guid=plib.getGUID(element);if(cacheEvents[guid])plib.loopObjectKeys(cacheEvents[guid],
function(key){plib.removeEvent(element,key)})},fireEvent:function(element,eventType){var evt;if(plib.hasEvent(element,eventType))if(document.createEvent){evt=document.createEvent("HTMLEvents");evt.initEvent(eventType,true,true);element.dispatchEvent(evt)}else{evt=document.createEventObject();evt.eventType=ieEventPrefix+eventType;element.fireEvent(evt.eventType,evt)}},click:function(element,callback,singlerun){singlerun=singlerun||false;if(callback)plib.addClass(element,classes.button);plib.addEvent(element,
events.click,function(evt){plib.stopBubble(evt);if(singlerun){plib.removeEvent(element,events.click);plib.removeClass(element,classes.button)}if(callback)callback.call(element,evt);return false})},jsonpGarbageCollect:function(scriptId){plib.removeElement(document.getElementById(scriptId));clearTimeout(jsonpTimeout[scriptId]);delete jsonpTimeout[scriptId];delete jsonpHandler[scriptId]},loadJSONP:function(srcURL,params,callback){var scriptId="JSONP_"+plib.randomID(12),urlRemote,strParams="",startTime=
(new Date).getTime();if(params)if(plib.isFunction(params)){callback=params;params=""}else if(plib.isObject(params)){strParams=plib.getParamsFromObject(params);strParams=strParams?"&"+strParams:""}urlRemote=directory.paths.hub+"?r="+srcURL+"&jsid="+scriptId+"&pk="+globalVars.publicKey+strParams;if(settings.jsonpTimeout>0)jsonpTimeout[scriptId]=setTimeout(function(){pfunc.error(messages.jsonpTimeout,urlRemote);if(callback)callback(null,settings.jsonpTimeout);plib.jsonpGarbageCollect(scriptId)},settings.jsonpTimeout);
jsonpHandler[scriptId]=function(data){var duration=(new Date).getTime()-startTime;if(callback)callback(data,duration);plib.jsonpGarbageCollect(scriptId)};plib.domAppend(html.script,document.getElementsByTagName(html.head).item(0),{id:scriptId,src:urlRemote,type:types.jstxt});pfunc.log(messages.jsonp,urlRemote)},stopAnimation:function(element){if(element.animationMemory)clearInterval(element.animationMemory)},animate:function(element,sCssProp,nTarget,uTotalTime,callback){var props=[],freq,startTime=
(new Date).getTime(),logProps=function(cssProp,cssValue){var o={};o.cssProp=cssProp;o.startValue=plib.getStyle(element,o.cssProp)||0;o.endValue=cssValue;o.displacement=o.endValue-o.startValue;if(!isNaN(o.startValue)&&!isNaN(o.endValue)&&!isNaN(o.displacement))props.push(o)};if(plib.isObject(sCssProp)){callback=uTotalTime;uTotalTime=nTarget;nTarget=null;plib.loopObject(sCssProp,function(key,val){logProps(key,val)})}else logProps(sCssProp,nTarget);if(props.length===0)return;freq=Math.PI/(2*uTotalTime);
if(element.animationMemory)plib.stopAnimation(element);element.animationMemory=setInterval(function(){var elapsedTime=(new Date).getTime()-startTime,f=Math.abs(Math.sin(elapsedTime*freq));if(elapsedTime<uTotalTime)plib.loopArray(props,function(value){plib.setStyle(element,value.cssProp,f*value.displacement+value.startValue)});else{plib.stopAnimation(element);plib.loopArray(props,function(value){plib.setStyle(element,value.cssProp,value.endValue)});if(callback)callback.call(element)}},10)},setAlpha:function(element,
n){if(support.opacity)element.style[css.opacity]=n;else element.style[css.filter]="alpha(opacity = "+String(n*100)+") "},fadeTo:function(element,alpha,speed,callback){plib.animate(element,css.opacity,alpha,speed,callback)},fadeIn:function(element,speed,callback){plib.fadeTo(element,1,speed,callback)},fadeOut:function(element,speed,callback){plib.fadeTo(element,0,speed,callback)},stripSpaces:function(s){return s.replace(regex.ss,"")},inArray:function(array,object){var result=false;plib.loopArray(array,
function(value){if(value===object){result=true;return null}});return result},arrayUnique:function(array){var r=[];plib.loopArray(array,function(value){if(!plib.inArray(r,value))r[r.length]=value});return r},removeArrayItem:function(array,itemToRemove){plib.loopArray(array,function(index,value){if(value===itemToRemove)array.splice(index,1)});return array},parseUrl:function(str){var key=["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file",
"query","anchor"],q="queryKey",m=regex.purl.exec(str),uri={},i=14;while(i--)uri[key[i]]=m[i]||"";uri[q]={};uri[key[12]].replace(regex.query,function($0,$1,$2){if($1)uri[q][$1]=$2});return uri},getFileExtension:function(url){var file=url?plib.parseUrl(url).file:null,ext=file?regex.fext.exec(file).pop():null;return ext?ext.toLowerCase():null},runInterval:function(nIntervalTime,nMaxIntervalCount,fnCondition,fnSuccess,fnFailure){var interval,count=0;if(fnCondition.call()===true)fnSuccess.call();else interval=
window.setInterval(function(){if(fnCondition.call()===true){clearInterval(interval);fnSuccess.call()}else{count++;if(count>=nMaxIntervalCount){window.clearInterval(interval);if(fnFailure)fnFailure.call()}}},nIntervalTime)},stringFormat:function(str,arr){var formatted=str;plib.loopArray(arr,function(index,value){var regexp=new RegExp("\\{"+index+"\\}","gi");formatted=formatted.replace(regexp,value)});return formatted}};commonHTML={buildForm:function(strFormName,arrNodes,strSubmitText){var oFormAttr=
{};arrNodes=[{nodeName:html.div,className:classes.formError}].concat(arrNodes);if(!plib.isUndefined(strSubmitText))arrNodes=arrNodes.concat([commonHTML.buildButton(strSubmitText)]);oFormAttr[attributes.name]=strFormName;return[{nodeName:html.form,id:strFormName,className:classes.formStyle,attr:oFormAttr,childNodes:arrNodes}]},buildFormInput:function(strType,strName){return{nodeName:html.input,attr:{type:strType,name:strName,autocomplete:"off"}}},buildFormTextArea:function(strName){return{nodeName:html.textarea,
attr:{name:strName}}},buildFormSelect:function(strName,arrOptions){var arrNodes=[];plib.loopObject(arrOptions,function(prop,val){arrNodes.push({nodeName:html.option,attr:{value:prop},text:val})});return{nodeName:html.select,attr:{name:strName},childNodes:arrNodes}},buildFormLabelSm:function(strLabel,oNode){return commonHTML.buildFormLabel(strLabel,oNode,true)},buildFormLabel:function(strLabel,oNode,small){var arrLabelTypes={},className=small?classes.formLabelSm:classes.formLabel;arrLabelTypes[html.input]=
classes.formTextField;arrLabelTypes[html.textarea]=classes.formTextArea;arrLabelTypes[html.select]=classes.formDropDown;return{nodeName:html.label,className:className+whiteSpace+arrLabelTypes[oNode.nodeName],text:strLabel+":"+whiteSpace,childNodes:[{nodeName:html.span,childNodes:[oNode]}]}},buildHeader:function(strWindowTitle){return{nodeName:html.div,className:classes.windowHeader,childNodes:[{nodeName:html.a,className:classes.logo,text:sysName,attr:{href:directory.paths.website}},{nodeName:html.h2,
className:classes.windowTitle,text:strWindowTitle}]}},buildButton:function(strButtonText,properties){var strBtnClass=classes.formBtnSubmit,oBtnAttr={type:types.button};if(properties){if(plib.isFunction(properties))properties=properties.call();if(plib.hasProperty(properties,attributes.className)){strBtnClass=strBtnClass+whiteSpace+properties[attributes.className];delete properties[attributes.className]}if(!plib.isObjectEmpty(properties))plib.mergeObject(oBtnAttr,properties)}return{nodeName:html.button,
className:strBtnClass,childNodes:[{nodeName:html.span,childNodes:[{nodeName:html.span,text:strButtonText}]}],attr:oBtnAttr}},backToLogin:{nodeName:html.div,className:classes.formOptions,childNodes:[{nodeName:html.span,className:classes.formOption_backToLogin,text:"Back to Login"}]},logoutTab:[{nodeName:html.span,className:classes.windowLogout,text:"LOGOUT"},{nodeName:html.span,className:classes.windowUserName}],buildModal:function(strHeader,arrNodes){arrNodes=[{nodeName:html.a,className:classes.logo,
attr:{href:directory.paths.website},text:sysName},{nodeName:html.h2,text:strHeader}].concat(arrNodes);return{nodeName:html.div,className:classes.modalMsg,childNodes:arrNodes}},simpleAdd:function(strNodeType,strNodeText){return{nodeName:strNodeType,text:strNodeText}}};layout={formTagCreate:commonHTML.buildForm(names.formCreate,commonHTML.logoutTab.concat([commonHTML.buildHeader("ADD NEW TAG"),commonHTML.buildFormInput(types.hidden,names.strWebReferer),commonHTML.buildFormInput(types.hidden,names.strImageURL),
commonHTML.buildFormInput(types.hidden,names.nPosX),commonHTML.buildFormInput(types.hidden,names.nPosY),commonHTML.buildFormLabel("Tag name",commonHTML.buildFormInput(types.text,names.strTagName)),commonHTML.buildFormLabel("Keywords",commonHTML.buildFormInput(types.text,names.strKeywords)),commonHTML.buildFormLabel("Destination url",commonHTML.buildFormInput(types.text,names.strWebLink))]),"SAVE & PUBLISH TAG"),formRegister:commonHTML.buildForm(names.formRegister,[commonHTML.buildHeader("ACCOUNT REGISTRATION"),
commonHTML.buildFormLabel("Full Name",commonHTML.buildFormInput(types.text,names.strFullName)),commonHTML.buildFormLabel("E-mail",commonHTML.buildFormInput(types.text,names.strUsername)),commonHTML.buildFormLabel("Password",commonHTML.buildFormInput(types.password,names.strPassword)),commonHTML.buildFormLabel("Confirm Pass",commonHTML.buildFormInput(types.password,names.strConfirmPass)),commonHTML.buildHeader("SITE REGISTRATION"),commonHTML.simpleAdd(html.p,"For "+sysName+" to work securely, it requires users to link their website to their account. Please provide us with some basic information about your website."),
commonHTML.buildFormLabel("Website Name",commonHTML.buildFormInput(types.text,names.strWebName)),commonHTML.buildFormLabel("Website Domain",commonHTML.buildFormInput(types.text,names.strWebURL)),commonHTML.backToLogin],"REGISTER"),formLogin:commonHTML.buildForm(names.formLogin,[commonHTML.buildHeader("ACCOUNT LOGIN"),commonHTML.buildFormLabel("E-mail",commonHTML.buildFormInput(types.text,names.strUsername)),commonHTML.buildFormLabel("Password",commonHTML.buildFormInput(types.password,names.strPassword)),
{nodeName:html.div,className:classes.formOptions,childNodes:[{nodeName:html.span,className:classes.formOption_forgotPass,text:"Forgot your password?"},{nodeName:html.span,className:classes.formOption_register,text:"Sign Up"}]}],"LOGIN"),formForgot:commonHTML.buildForm(names.formForgot,[commonHTML.buildHeader("FORGOT PASSWORD"),commonHTML.buildFormLabel("E-mail",commonHTML.buildFormInput(types.text,names.strUsername)),commonHTML.backToLogin],"RETRIEVE PASSWORD"),formSettings:commonHTML.buildForm(names.formSettings,
commonHTML.logoutTab.concat([commonHTML.buildHeader("UPDATE SETTINGS"),commonHTML.simpleAdd(html.p,"This form allows administrators to change how "+sysName+" interacts with images. This form is not accessible to the public."),commonHTML.buildButton("REPOSITION TAGS",function(){var objAttributes={};objAttributes[attributes.className]=classes.formBtnLeft;objAttributes[attributes.name]=names.btnRepositionTags;return objAttributes}),commonHTML.buildButton("REMOVE TAGS",function(){var objAttributes={};
objAttributes[attributes.className]=classes.formBtnLeft;objAttributes[attributes.name]=names.btnRemoveTags;return objAttributes}),commonHTML.buildButton("OPEN IMAGES IN LIGHTBOX",function(){var objAttributes={};objAttributes[attributes.className]=classes.formBtnLeft;objAttributes[attributes.name]=names.btnOpenLightbox;return objAttributes})])),msgTagDeleted:commonHTML.buildModal("This tag has been deleted.",[commonHTML.simpleAdd(html.p,"Note: because you are either the owner of the image, or the tags creator, you are able to delete it whereas the public would only be able to report.")]),
msgForgot:commonHTML.buildModal("You have requested a new password.",[commonHTML.simpleAdd(html.p,"A new password has been generated and sent to your email address. We recommend that you change it asap!")]),msgRegistered:commonHTML.buildModal("Registration was successful.",[commonHTML.simpleAdd(html.p,"You have just created your account! Easy right? However there is one last step: your email needs to be authenticated. Please check your inbox for a confirmation email. If you do not receive an email within the hour, please contact our support team.")]),
msgNoPermission:commonHTML.buildModal("You do not have sufficient permission.",[commonHTML.simpleAdd(html.p,"The owner of this website has requested your account not be able to add or request tags. Please contact the site owner for more information.")]),msgImageDisabled:commonHTML.buildModal("This image has been disabled.",[commonHTML.simpleAdd(html.p,"The "+sysName+" interface will no longer show on this image. If you wish the enable the interface, you can do so in the settings window.")]),msgImageEnabled:commonHTML.buildModal("This image has been enabled.",
[commonHTML.simpleAdd(html.p,"The "+sysName+" interface will now show on this image. If you wish the disabled the interface, you can do so in the settings window.")]),msgFirstTag:commonHTML.buildModal("This appears to be your first tag!",[commonHTML.simpleAdd(html.p,"Luckily for you, we have made it as easy as possible. Here are some simple instructions to get you started."),{nodeName:html.ol,childNodes:[{nodeName:html.li,text:"Click on the image where you would like the tag to appear."},{nodeName:html.li,
text:"A popup form will obtain some information relevant to the tag."},{nodeName:html.li,text:"Click save and you're off to the races."}]},commonHTML.buildButton("GREAT, LET'S GET STARTED")]),confirmPrompt:{nodeName:html.div,className:classes.prompt,childNodes:[commonHTML.buildHeader("PLEASE CONFIRM"),{nodeName:html.p,className:classes.promptMessage},commonHTML.buildButton("YES I DO",{"class":classes.promptAccept}),commonHTML.buildButton("NO THANKS",{"class":classes.promptDeny})]}};function PinUi(PinInst){this.scope=
PinInst;this.hasUi=false;this.isHidden=false;this.allowPrivateInterfaces=false;this.offsetLeft=0;this.offsetRight=0;this.leftNavItems=[{className:classes.btnAddnew,label:"ADD NEW TAG",isPrivate:true,event:function(ui,button){var action=function(){if(userInfo[serverKeys.user.tagTotal]===0)pfunc.openWindow(layout.msgFirstTag,function(e){plib.click(plib.getElementsByClassName(classes.formBtnSubmit,this)[0],function(){pfunc.closeWindow();ui.scope.startTaggingMode(ui.scope.methodAddNewTag)})});else ui.scope.startTaggingMode(ui.scope.methodAddNewTag)};
pfunc.waitButton(button,messages.leftNavWait);pfunc.checkLogin(action,function(){pfunc.promptLogin(action)},function(){pfunc.unwaitButton(button)})}}]}PinUi.prototype={init:function(){var ui=this,guiLeftHolder=plib.domAppend(html.div,ui.scope.privateElements.imgOverlay,{"class":classes.guiLeftHolder}),guiRightHolder=plib.domAppend(html.div,ui.scope.privateElements.imgOverlay,{"class":classes.guiRightHolder}),btnCancel=plib.domAppend(html.span,guiRightHolder,{"class":classes.guiTopR+whiteSpace+classes.btnCancel});
ui.offsetLeft=plib.getWidth(guiLeftHolder)-Math.abs(plib.getStyle(guiLeftHolder,css.left));ui.offsetRight=10;plib.disableSelection(btnCancel);plib.addEvent(btnCancel,events.mouseover,function(){if(settings.animations)plib.animate(guiRightHolder,css.right,0,settings.navAniSpeed);else plib.setStyle(guiRightHolder,css.right,0)});plib.addEvent(btnCancel,events.mouseout,function(){if(settings.animations)plib.animate(guiRightHolder,css.right,-ui.offsetRight,settings.navAniSpeed);else plib.setStyle(guiRightHolder,
css.right,-ui.offsetRight)});ui.scope.privateElements.guiLeftHolder=guiLeftHolder;ui.scope.privateElements.guiRightHolder=guiRightHolder;ui.scope.privateElements.btnCancel=btnCancel},ownerInit:function(){var ui=this,btnSettings=plib.domAppend(html.span,ui.scope.privateElements.imgOverlay,{"class":classes.btnSettings});plib.setAlpha(btnSettings,opacities.semi);plib.addEvent(btnSettings,events.mouseover,function(){if(settings.animations)plib.fadeTo(btnSettings,opacities.full,settings.navAniSpeed);else plib.setAlpha(btnSettings,
opacities.full)});plib.addEvent(btnSettings,events.mouseout,function(){if(settings.animations)plib.fadeTo(btnSettings,opacities.semi,settings.navAniSpeed);else plib.setAlpha(btnSettings,opacities.semi)});plib.click(btnSettings,function(){pfunc.promptSettings(ui.scope.image)});ui.scope.privateElements.btnSettings=btnSettings},check:function(){var ui=this;ui.allowPrivateInterfaces=ui.hasOwnerPrivileges();if(!ui.hasUi)ui.build()},build:function(){var ui=this;plib.loopArray(ui.leftNavItems,function(value){if(value.isPrivate&&
!ui.allowPrivateInterfaces)return;var elmNavButton=plib.domAppend(html.span,ui.scope.privateElements.guiLeftHolder,{"class":classes.guiBotL+whiteSpace+value.className},value.label);plib.disableSelection(elmNavButton);pfunc.setFluidWidth(elmNavButton);plib.addEvent(elmNavButton,events.mouseover,function(){var offsetLeft=plib.attribute(this,attributes.fluidWidth)-ui.offsetLeft+5;if(settings.animations)plib.animate(this,css.left,offsetLeft,settings.navAniSpeed);else plib.setStyle(this,css.left,offsetLeft)});
plib.addEvent(elmNavButton,events.mouseout,function(){if(settings.animations)plib.animate(this,css.left,0,settings.navAniSpeed);else plib.setStyle(this,css.left,0)});plib.click(elmNavButton,function(){value.event(ui,elmNavButton)})});if(ui.allowPrivateInterfaces)ui.ownerInit();ui.hasUi=true},destroy:function(){var ui=this,existingGuiLeft=plib.getElementsByClassName(classes.guiBotL,ui.scope.privateElements.guiLeftHolder);if(existingGuiLeft.length>0)plib.loopArray(existingGuiLeft,function(value){plib.removeElement(value)});
if(ui.scope.privateElements.btnSettings)plib.removeElement(ui.scope.privateElements.btnSettings);ui.hasUi=false},enableCancelMode:function(text,callback){var ui=this,guiRightHolder=ui.scope.privateElements.guiRightHolder,btnCancel=ui.scope.privateElements.btnCancel,cancelAction=function(){ui.disableCancelMode(callback)};plib.click(btnCancel,cancelAction);pfunc.newKeyListener(keyCodes.esc,ui.scope.pinUID,cancelAction);plib.textContent(btnCancel,text);plib.show(guiRightHolder);if(settings.animations)plib.animate(guiRightHolder,
css.right,-ui.offsetRight,settings.navAniSpeed)},disableCancelMode:function(callback){var ui=this,guiRightHolder=ui.scope.privateElements.guiRightHolder,btnCancel=ui.scope.privateElements.btnCancel,eventHolder;plib.removeEvent(btnCancel,events.click);pfunc.removeKeyListener(keyCodes.esc,ui.scope.pinUID);if(settings.animations){eventHolder=pfunc.deactivateEvents(btnCancel,[events.mouseover,events.mouseout]);plib.animate(guiRightHolder,css.right,-plib.getWidth(guiRightHolder),settings.navAniSpeed,function(){pfunc.activateEvents(btnCancel,
eventHolder);plib.hide(guiRightHolder);plib.removeChildren(btnCancel)})}else{plib.hide(guiRightHolder);plib.removeChildren(btnCancel)}if(callback)callback.call()},drawTooltip:function(canvas,properties){var ctx,cornerRadius=properties.cornerRadius,pointerWidth=properties.pointerWidth,pointerHeight=properties.pointerHeight,canvasPadding=properties.canvasPadding,halfPixel=properties.halfPixel,canvasWidth=properties.width,canvasHeight=properties.height,bubbleWidth=properties.width-canvasPadding*2-halfPixel*
2,bubbleHeight=properties.height-canvasPadding*2-halfPixel*2,bubbleFill,orientation=properties.orientation,pointerPos,verticalOffset=orientation===globalVars.tooltipOrientations.bottom?pointerHeight:0,horizontalOffset=orientation===globalVars.tooltipOrientations.right?pointerWidth:0,radial=function(deg){return Math.PI/180*deg},pointerOffset={top:pointerHeight/2,right:pointerWidth/2,bottom:pointerHeight/2,left:pointerWidth/2},corners={topLeft:true,topRight:true,bottomLeft:true,bottomRight:true};if(orientation===
globalVars.tooltipOrientations.top||orientation===globalVars.tooltipOrientations.bottom){pointerPos=bubbleWidth/2;canvasHeight+=pointerHeight;if(properties.offsetLeft<canvasWidth/2){pointerPos=properties.offsetLeft-canvasPadding;if(properties.offsetLeft-canvasPadding-cornerRadius<pointerWidth/2){pointerOffset.left=0;corners.topLeft=orientation===globalVars.tooltipOrientations.bottom?false:true;corners.bottomLeft=orientation===globalVars.tooltipOrientations.top?false:true}}else if(properties.offsetRight<
canvasWidth/2){pointerPos=canvasWidth-properties.offsetRight-canvasPadding;if(properties.offsetRight-canvasPadding-cornerRadius<pointerWidth/2){pointerOffset.right=0;corners.topRight=orientation===globalVars.tooltipOrientations.bottom?false:true;corners.bottomRight=orientation===globalVars.tooltipOrientations.top?false:true}}}else if(orientation===globalVars.tooltipOrientations.left||orientation===globalVars.tooltipOrientations.right){pointerPos=bubbleHeight/2;canvasWidth+=pointerWidth}if(cornerRadius<=
0){corners.topLeft=false;corners.topRight=false;corners.bottomLeft=false;corners.bottomRight=false}canvas.width=canvasWidth;canvas.height=canvasHeight;plib.setWidth(canvas,canvasWidth);plib.setHeight(canvas,canvasHeight);ctx=pfunc.getCanvasContext(canvas,"2d");ctx.translate(canvasPadding+horizontalOffset+halfPixel,canvasPadding+verticalOffset+halfPixel);ctx.beginPath();if(corners.topLeft){ctx.moveTo(0,cornerRadius);ctx.arc(cornerRadius,cornerRadius,cornerRadius,radial(180),radial(270),false)}else ctx.moveTo(0,
0);if(orientation===globalVars.tooltipOrientations.bottom){ctx.lineTo(pointerPos-pointerOffset.left,0);ctx.lineTo(pointerPos,-pointerHeight);ctx.lineTo(pointerPos+pointerOffset.right,0)}if(corners.topRight){ctx.lineTo(bubbleWidth-cornerRadius,0);ctx.arc(bubbleWidth-cornerRadius,cornerRadius,cornerRadius,radial(270),radial(0),false)}else ctx.lineTo(bubbleWidth,0);if(orientation===globalVars.tooltipOrientations.left){ctx.lineTo(bubbleWidth,pointerPos-pointerOffset.top);ctx.lineTo(bubbleWidth+pointerWidth,
pointerPos);ctx.lineTo(bubbleWidth,pointerPos+pointerOffset.bottom)}if(corners.bottomRight){ctx.lineTo(bubbleWidth,bubbleHeight-cornerRadius);ctx.arc(bubbleWidth-cornerRadius,bubbleHeight-cornerRadius,cornerRadius,radial(0),radial(90),false)}else ctx.lineTo(bubbleWidth,bubbleHeight);if(orientation===globalVars.tooltipOrientations.top){ctx.lineTo(pointerPos+pointerOffset.right,bubbleHeight);ctx.lineTo(pointerPos,bubbleHeight+pointerHeight);ctx.lineTo(pointerPos-pointerOffset.left,bubbleHeight)}if(corners.bottomLeft)ctx.arc(cornerRadius,
bubbleHeight-cornerRadius,cornerRadius,radial(90),radial(180),false);else ctx.lineTo(0,bubbleHeight);if(orientation===globalVars.tooltipOrientations.right){ctx.lineTo(0,pointerPos+pointerOffset.bottom);ctx.lineTo(-pointerWidth,pointerPos);ctx.lineTo(0,pointerPos-pointerOffset.top)}ctx.closePath();if(properties.allowShadow){ctx.shadowColor=properties.theme.shadowColor;ctx.shadowOffsetX=properties.theme.shadowOffsetX;ctx.shadowOffsetY=properties.theme.shadowOffsetY;ctx.shadowBlur=properties.theme.shadowBlur}if(properties.theme.backgroundStyle===
globalVars.canvasDrawStyles.radial){bubbleFill=ctx.createRadialGradient(bubbleWidth/2,bubbleHeight/2,0,bubbleWidth/2,bubbleHeight/2,bubbleWidth>bubbleHeight?bubbleWidth:bubbleHeight);plib.loopArray(properties.theme.backgroundColor.split(" "),function(value){var colorInfo=value.split("-");bubbleFill.addColorStop(colorInfo[0],colorInfo[1])})}else if(properties.theme.backgroundStyle===globalVars.canvasDrawStyles.linear){bubbleFill=ctx.createLinearGradient(bubbleWidth/2,0,bubbleWidth/2,bubbleHeight);
plib.loopArray(properties.theme.backgroundColor.split(" "),function(value){var colorInfo=value.split("-");bubbleFill.addColorStop(colorInfo[0],colorInfo[1])})}else if(properties.theme.backgroundStyle===globalVars.canvasDrawStyles.solid)bubbleFill=properties.theme.backgroundColor;ctx.fillStyle=bubbleFill;ctx.fill();if(properties.allowStroke){if(properties.allowShadow){ctx.shadowColor=null;ctx.shadowOffsetX=null;ctx.shadowOffsetY=null;ctx.shadowBlur=null}ctx.strokeStyle=properties.theme.strokeColor;
ctx.lineWidth=properties.theme.strokeWidth;ctx.stroke()}},hasOwnerPrivileges:function(){return!!userInfo[serverKeys.user.isOwner]},show:function(bAnimate){var ui=this,guiLeftHolder=ui.scope.privateElements.guiLeftHolder,btnSettings=ui.scope.privateElements.btnSettings,nLeftPosition=ui.offsetLeft-plib.getWidth(guiLeftHolder);ui.isHidden=false;bAnimate=bAnimate||true;if(settings.animations&&bAnimate){plib.show(guiLeftHolder);plib.animate(guiLeftHolder,css.left,nLeftPosition,settings.navAniSpeed);if(btnSettings){plib.show(btnSettings);
plib.fadeTo(btnSettings,opacities.semi,settings.navAniSpeed)}}else{plib.setStyle(guiLeftHolder,css.left,nLeftPosition);if(btnSettings)plib.show(btnSettings)}},hide:function(bAnimate){var ui=this,guiLeftHolder=ui.scope.privateElements.guiLeftHolder,btnSettings=ui.scope.privateElements.btnSettings,nLeftPosition=-plib.getWidth(guiLeftHolder),eventHolder=[];ui.isHidden=true;bAnimate=bAnimate||true;if(settings.animations&&bAnimate){if(btnSettings){eventHolder[0]=pfunc.deactivateEvents(btnSettings,[events.mouseover,
events.mouseout]);plib.fadeOut(btnSettings,settings.navAniSpeed,function(){pfunc.activateEvents(btnSettings,eventHolder[0]);plib.hide(btnSettings)})}eventHolder[1]=pfunc.deactivateEvents(guiLeftHolder,[events.mouseover,events.mouseout]);plib.animate(guiLeftHolder,css.left,nLeftPosition,settings.navAniSpeed,function(){pfunc.activateEvents(guiLeftHolder,eventHolder[1]);plib.hide(guiLeftHolder)});plib.loopArray(guiLeftHolder.children,function(value){var len=eventHolder.length++;eventHolder[len]=pfunc.deactivateEvents(value,
[events.mouseover,events.mouseout]);plib.animate(value,css.left,0,settings.navAniSpeed,function(){pfunc.activateEvents(value,eventHolder[len])})})}else{plib.setStyle(guiLeftHolder,css.left,nLeftPosition);if(btnSettings)plib.hide(btnSettings)}},toggle:function(bAnimate){if(this.isHidden)this.show(bAnimate);else this.hide(bAnimate)}};function PinInst(image,uid){this.uid=uid;this.image=image;this.imageSrc=plib.attribute(image,settings.altImageSrc)||image.src;this.imageClone=image.cloneNode(true);this.disallowNodeUpdate=
false;this.allowTagBubble=true;this.privateElements={};this.settings={};this.dimensions={width:image.width,height:image.height,offsetLeft:cacheImages[uid].offset.x,offsetTop:cacheImages[uid].offset.y};this.updateInProgress=false}PinInst.prototype={destroy:function(bRemove){var pInst=this;if(bRemove)plib.removeElement(pInst.privateElements.imgNode);else plib.replaceElement(pInst.privateElements.imgNode,pInst.imageClone);delete cacheNodes[pInst.uid];delete cacheImages[pInst.uid];delete cacheTags[pInst.uid];
pfunc.info(messages.imageUnloaded,pInst.uid)},init:function(){var pInst=this,oImageStyles=plib.getComputedStyles(pInst.image),localCheckImage,localCheckImageNS=oNamespace.checkImage+pInst.imageCloneSrc;plib.attribute(pInst.image,attributes.imgLoaded,strBool[1]);plib.addClass(pInst.image,classes.image);pInst.privateElements.imgNode=plib.domWrap(html.div,pInst.image,{"class":classes.node});if(oImageStyles[css.display]==="inline")plib.addClass(pInst.privateElements.imgNode,classes.inlineNode);cacheNodes[pInst.uid]=
{instance:pInst,imgGUID:plib.getGUID(pInst.image)};plib.click(pInst.privateElements.imgNode);if(pInst.settings.cssHelper)pInst.styleHelper(oImageStyles);plib.setWidth(pInst.image,pInst.dimensions.width);plib.setHeight(pInst.image,pInst.dimensions.height);plib.setStyle(pInst.image,css.maxWidth,pInst.dimensions.width);plib.setStyle(pInst.image,css.maxHeight,pInst.dimensions.height);plib.attribute(pInst.image,attributes.width,null);plib.attribute(pInst.image,attributes.height,null);plib.setWidth(pInst.privateElements.imgNode,
pInst.dimensions.width);plib.setHeight(pInst.privateElements.imgNode,pInst.dimensions.height);if(pInst.settings.posHelper)pInst.positionHelper();pInst.privateElements.sectionBody=plib.domWrap(html.div,pInst.image,{"class":classes.sectionBody});plib.setWidth(pInst.privateElements.sectionBody,pInst.dimensions.width);plib.setHeight(pInst.privateElements.sectionBody,pInst.dimensions.height);pInst.privateElements.imgOverlay=plib.domAppend(html.div,pInst.privateElements.sectionBody,{"class":classes.overlay});
plib.setWidth(pInst.privateElements.imgOverlay,pInst.dimensions.width);plib.setHeight(pInst.privateElements.imgOverlay,pInst.dimensions.height);pInst.privateElements.imgTagHolder=plib.domAppend(html.div,pInst.privateElements.imgOverlay,{"class":classes.tagHolder});pInst.preRun();localCheckImage=pfunc.getLocalStorage(localCheckImageNS);if(localCheckImage){pInst.imageSrc=localCheckImage;if(pInst.imageCloneSrc!==pInst.imageSrc)pfunc.info(messages.imageNewSrc,pInst.imageCloneSrc,pInst.imageSrc);pInst.postRun()}else plib.loadJSONP(directory.names.checkImage,
{"strImageURL":pInst.imageSrc},function(data){if(data){pInst.imageSrc=data;pfunc.info(messages.imageNewSrc,pInst.imageCloneSrc,pInst.imageSrc)}pfunc.setLocalStorage(localCheckImageNS,pInst.imageSrc);pInst.postRun()})},positionHelper:function(){var pInst=this,cumulativeOffset=plib.getCumulativeOffset(pInst.image),positionType=plib.getStyle(pInst.privateElements.imgNode,css.position),posMethod=positionType==="absolute"?{top:css.top,left:css.left}:{top:css.margin.top,left:css.margin.left},posLeft=plib.getStyle(pInst.privateElements.imgNode,
posMethod.left)||0,posTop=plib.getStyle(pInst.privateElements.imgNode,posMethod.top)||0,offsetDiffX=pInst.dimensions.offsetLeft-cumulativeOffset.x+posLeft,offsetDiffY=pInst.dimensions.offsetTop-cumulativeOffset.y+posTop;if(offsetDiffX>0){plib.setStyle(pInst.privateElements.imgNode,posMethod.left,offsetDiffX);pInst.dimensions.offsetLeft=offsetDiffX}if(offsetDiffY>0){plib.setStyle(pInst.privateElements.imgNode,posMethod.top,offsetDiffY);pInst.dimensions.offsetTop=offsetDiffY}},styleHelper:function(oCss){var pInst=
this,oNodeStyle,oImageStyle;delete oCss[css.display];if(oCss[css.position]==="static")delete oCss[css.position];plib.attribute(pInst.image,attributes.style,null);plib.attribute(pInst.image,attributes.align,null);plib.attribute(pInst.image,attributes.hspace,null);plib.attribute(pInst.image,attributes.vspace,null);oNodeStyle=plib.getComputedStyles(pInst.privateElements.imgNode);oImageStyle=plib.getComputedStyles(pInst.image);plib.loopObject(oCss,function(key,val){if(!plib.inArray(["width","height",
"color"],key)){var nodePropVal=oNodeStyle[key],imgPropVal=oImageStyle[key];if(val!==nodePropVal)plib.setStyle(pInst.privateElements.imgNode,key,val);if(imgPropVal!==nodePropVal)plib.setStyle(pInst.image,key,nodePropVal)}})},preRun:function(){var pInst=this;if(pInst.settings.allowBottomLinks===true){pInst.privateElements.sectionFooter=plib.domAppend(html.div,pInst.privateElements.imgNode,{"class":classes.sectionFooter});pInst.privateElements.linkHolder=plib.domAppend(html.div,pInst.privateElements.sectionFooter,
{"class":classes.linkHolder});plib.domAppend(html.div,pInst.privateElements.sectionFooter,{"class":classes.linkHolderBackground});plib.hide(pInst.privateElements.sectionFooter)}pInst.ui=new PinUi(pInst);pInst.ui.init();plib.addEvent(pInst.privateElements.imgNode,events.mouseover,function(event){if((new pfunc.MouseBoundaryCrossing(event,this)).enteredLandmark)pInst.enableImgNode()});plib.addEvent(pInst.privateElements.imgNode,events.mouseout,function(event){if((new pfunc.MouseBoundaryCrossing(event,
this)).leftLandmark)pInst.disableImgNode()});if(pInst.settings.alwaysShowTags)plib.addClass(pInst.privateElements.imgNode,classes.actionOn)},postRun:function(){var pInst=this;pfunc.log(messages.instOutput,pInst);if(pInst.settings.alwaysShowTags)pfunc.checkLogin(null,null,function(){pfunc.methodSessionChange(pInst)})},methodAddNewTag:function(pos){var pInst=this;pfunc.openPrivateWindow(layout.formTagCreate,function(){var newTagForm=document.forms[names.formCreate];newTagForm.elements[names.strWebReferer].value=
windowLocation;newTagForm.elements[names.strImageURL].value=pInst.imageSrc;newTagForm.elements[names.nPosX].value=pos.x;newTagForm.elements[names.nPosY].value=pos.y;pfunc.manageTagSuggestionList(newTagForm);pfunc.manageKeywords(newTagForm.elements[names.strKeywords]);pfunc.validWebUrl(newTagForm.elements[names.strWebLink]);pfunc.manageFormSubmit(newTagForm,directory.names.tagCreate,[asterisk],function(data){if(data)pfunc.displayFormError(this,data);else{pfunc.closeWindow();pInst.updateNode(true,true);
userInfo[serverKeys.user.tagTotal]+=1}})})},updateNode:function(forceRedraw,forceReload){var pInst=this,drawInstanceFromCache=function(){var timestamp=cacheTagData[this.imageSrc][0],data=cacheTagData[this.imageSrc][1];this.tagsVersion=timestamp;if(data&&!plib.isObjectEmpty(data)){this.drawTagData(data);if(this.settings.allowBottomLinks)this.drawLinkData(data)}};forceRedraw=forceRedraw|false;forceReload=forceReload|false;if(pInst.updateInProgress===true)return;pInst.updateInProgress=true;if(forceReload)delete cacheTagData[pInst.imageSrc];
if(plib.hasProperty(cacheTagData,pInst.imageSrc)){if(forceRedraw||pInst.tagsVersion!==cacheTagData[pInst.imageSrc][0])drawInstanceFromCache.call(pInst);pInst.updateInProgress=false}else{if(!plib.hasProperty(queueTagData,pInst.uid))queueTagData[pInst.uid]=[];if(!plib.inArray(queueTagData[pInst.uid],pInst))queueTagData[pInst.uid].push(pInst);if(queueTagData[pInst.uid].length>1)return;plib.loadJSONP(directory.names.getTags,{"strImageURL":pInst.imageSrc},function(data){if(data!==null){cacheTagData[pInst.imageSrc]=
[(new Date).getTime(),data];plib.loopArray(queueTagData[pInst.uid],function(PinInst){drawInstanceFromCache.call(PinInst)});delete queueTagData[pInst.uid]}pInst.updateInProgress=false})}},tagMouseoverEvent:function(elmTag){var pInst=this,elmTagDot=plib.getElementsByClassName(classes.tagDot,elmTag)[0],elmTagOutline=plib.getElementsByClassName(classes.tagOutline,elmTag)[0],elmTagBubble=plib.getElementsByClassName(classes.tagBubble,elmTag)[0],oStyles={},outlineSize,parameters;plib.setStyle(elmTag,css.zIndex,
999);plib.setStyle(pInst.privateElements.imgTagHolder,css.zIndex,999);if(elmTagDot&&elmTagOutline){plib.show(elmTagOutline);outlineSize=pInst.settings.dotOutlineSize*2+plib.getWidth(elmTagDot);oStyles[css.width]=outlineSize;oStyles[css.height]=outlineSize;oStyles[css.margin.top]=-Math.floor(outlineSize/2);oStyles[css.margin.left]=-Math.floor(outlineSize/2);if(settings.animations)plib.animate(elmTagOutline,oStyles,200);else plib.setStyles(elmTagOutline,oStyles)}if(elmTagBubble&&pInst.allowTagBubble)plib.show(elmTagBubble);
parameters=pfunc.getTagGuidObject(elmTag);if(parameters)plib.loadJSONP(directory.names.logTagHover,parameters)},tagMouseoutEvent:function(elmTag){var pInst=this,elmTagOutline=plib.getElementsByClassName(classes.tagOutline,elmTag)[0],elmTagBubble=plib.getElementsByClassName(classes.tagBubble,elmTag)[0],oStyles={};plib.setStyle(elmTag,css.zIndex,1);plib.setStyle(pInst.privateElements.imgTagHolder,css.zIndex,1);if(elmTagOutline){oStyles[css.width]=0;oStyles[css.height]=0;oStyles[css.margin.top]=0;oStyles[css.margin.left]=
0;if(settings.animations)plib.animate(elmTagOutline,oStyles,600,function(){plib.hide(this)});else{plib.setStyles(elmTagOutline,oStyles);plib.hide(elmTagOutline)}}if(elmTagBubble)plib.hide(elmTagBubble)},clearTagData:function(){plib.loopObjectKeys(cacheTagData,function(key){delete cacheTagData[key]})},drawTagData:function(oTagData){var pInst=this,allowFadeIn=plib.isElementEmpty(pInst.privateElements.imgTagHolder);plib.removeChildren(pInst.privateElements.imgTagHolder);plib.setAlpha(pInst.privateElements.imgTagHolder,
0);plib.loopObject(oTagData,function(data){var oDefData=data[0],randID=plib.randomID(12),charLenLimit=25,elmTag,elmTagDot,elmTagOutline,elmTagBubble,documentFragment,oParameters,outlineMargins,tagMultiGuid=[];oParameters={};oParameters[attributes.id]=tagPrefix+pInst.uid+"-"+randID;oParameters[attributes.className]=classes.tag+whiteSpace+globalVars.availableDotSizes[settings.dotSize];oParameters[attributes.tagPosX]=oDefData[serverKeys.tags.posX];oParameters[attributes.tagPosY]=oDefData[serverKeys.tags.posY];
if(data.length>1){plib.loopObject(data,function(v){tagMultiGuid.push(v[serverKeys.tags.guid])});oParameters[attributes.tagMultiGuid]=tagMultiGuid.join("_")}else oParameters[attributes.tagGuid]=oDefData[serverKeys.tags.guid];elmTag=plib.domAppend(html.div,pInst.privateElements.imgTagHolder,oParameters);plib.setStyle(elmTag,css.left,String(oDefData[serverKeys.tags.posX]*100)+"%");plib.setStyle(elmTag,css.top,String(oDefData[serverKeys.tags.posY]*100)+"%");oParameters={};oParameters[attributes.className]=
classes.tagDot;elmTagDot=plib.domAppend(html.a,elmTag,oParameters);pfunc.setWindowLink(elmTagDot,directory.paths.webloc+oDefData[serverKeys.tags.guid]);if(pInst.settings.dotOutlineSize>0){oParameters={};oParameters[attributes.className]=classes.tagOutline;elmTagOutline=plib.domAppend(html.span,elmTag,oParameters);outlineMargins={};outlineMargins[css.width]=0;outlineMargins[css.height]=0;outlineMargins[css.margin.top]=0;outlineMargins[css.margin.left]=0;plib.setStyles(elmTagOutline,outlineMargins)}if(pInst.settings.tooltip){documentFragment=
document.createDocumentFragment();if(!plib.hasProperty(cacheTags,pInst.uid))cacheTags[pInst.uid]={};plib.loopArray(data,function(index,value){var strTagName=value[serverKeys.tags.name],strKeywords=value[serverKeys.tags.keywords].join(),strWebLink=value[serverKeys.tags.webLink],strGUID=value[serverKeys.tags.guid],nOwnerId=value[serverKeys.tags.ownerGuid],elmTagLink,elmTagLinkText,strTagLinkText;cacheTags[pInst.uid][strGUID]=randID;oParameters={};oParameters[attributes.id]=tagPrefix+randID+"-"+strGUID;
oParameters[attributes.className]=classes.tagLink;oParameters[attributes.tagGuid]=strGUID;oParameters[attributes.tagName]=strTagName;oParameters[attributes.tagKeywords]=strKeywords;oParameters[attributes.tagWebLink]=strWebLink;oParameters[attributes.tagOwnerId]=nOwnerId;elmTagLink=plib.domAppend(html.span,documentFragment,oParameters);strTagLinkText=strTagName.length>charLenLimit?strTagName.substr(0,charLenLimit)+ellipsis:strTagName;oParameters={};oParameters[attributes.className]=classes.tagLinkText;
elmTagLinkText=plib.domAppend(html.a,elmTagLink,oParameters,strTagLinkText);pfunc.setWindowLink(elmTagLinkText,directory.paths.webloc+strGUID);if(pInst.settings.tooltipURL){plib.loopArray(webProtos,function(value){strWebLink=strWebLink.replace(value,"")});strWebLink=strWebLink.replace(regex.tslash,"");if(strWebLink.length>charLenLimit)strWebLink=strWebLink.substr(0,charLenLimit)+ellipsis;oParameters={};oParameters[attributes.className]=classes.tagLinkURL;plib.domAppend(html.span,elmTagLink,oParameters,
strWebLink)}if(pInst.settings.allowShare){oParameters={};oParameters[attributes.className]=classes.tagLinkLike;plib.click(plib.domAppend(html.span,elmTagLink,oParameters,"like"),function(){pInst.manageTagLike(this)});plib.setStyle(elmTagLink,css.padding.right,18)}if(index+1===data.length)plib.addClass(elmTagLink,classes.lastItem)});elmTagBubble=pInst.drawTagBubble(elmTag,documentFragment);plib.hide(elmTagBubble)}plib.addEvent(elmTag,events.mouseover,function(event){var elmTag=plib.getParentByClassName(this,
classes.tag);if((new pfunc.MouseBoundaryCrossing(event,this)).enteredLandmark)pInst.tagMouseoverEvent(elmTag)});plib.addEvent(elmTag,events.mouseout,function(event){var elmTag=plib.getParentByClassName(this,classes.tag);if((new pfunc.MouseBoundaryCrossing(event,this)).leftLandmark)pInst.tagMouseoutEvent(elmTag)})});if(allowFadeIn)plib.fadeIn(pInst.privateElements.imgTagHolder,800);else plib.setAlpha(pInst.privateElements.imgTagHolder,1)},drawTagBubble:function(elmTag,tagBubbleContent){var pInst=this,
elmTagDot=plib.getElementsByClassName(classes.tagDot,elmTag)[0],elmTagBubble,elmTagBubbleContent,o={},p={},tooltipPosition={},tooltipOrientation=pInst.settings.tooltipOrientation,oParameters,canvas;oParameters={};oParameters[attributes.className]=classes.tagBubble;elmTagBubble=plib.domAppend(html.span,elmTag,oParameters);oParameters={};oParameters[attributes.className]=classes.tagBubbleContent;elmTagBubbleContent=plib.domAppend(html.span,elmTagBubble,oParameters);plib.domAppend(tagBubbleContent,elmTagBubbleContent);
o.t=plib.getCumulativeOffset(elmTag);o.th=plib.getCumulativeOffset(pInst.privateElements.imgTagHolder);p.halfPixel=pInst.settings.canvas.stroke&&pInst.settings.canvas.theme.strokeWidth%2!==0?0.5:0;p.bubblePadding=3;p.bubbleDotDist=plib.getWidth(elmTagDot)/2;p.tagBubbleWidth=plib.getWidth(elmTagBubble)+p.halfPixel*2;p.tagBubbleHeight=plib.getHeight(elmTagBubble)+p.halfPixel*2;p.tagHolderWidth=plib.getWidth(pInst.privateElements.imgTagHolder);p.tagHolderHeight=plib.getHeight(pInst.privateElements.imgTagHolder);
p.tagBubbleContentHeight=plib.getHeight(elmTagBubbleContent);p.tagOffsetTop=o.t.y-o.th.y;p.tagOffsetBottom=p.tagHolderHeight-p.tagOffsetTop;p.tagOffsetLeft=o.t.x-o.th.x;p.tagOffsetRight=p.tagHolderWidth-p.tagOffsetLeft;p.tailWidth=pInst.settings.canvas.tailWidth;p.tailHeight=pInst.settings.canvas.tailHeight;p.totalWidth=p.tagBubbleWidth;p.totalHeight=p.tagBubbleHeight;tooltipPosition[css.top]="auto";tooltipPosition[css.right]="auto";tooltipPosition[css.bottom]="auto";tooltipPosition[css.left]="auto";
if(tooltipOrientation===globalVars.tooltipOrientations.top||tooltipOrientation===globalVars.tooltipOrientations.bottom){tooltipPosition[css.left]=-(p.tagBubbleWidth/2);p.totalHeight+=p.tailHeight}else if(tooltipOrientation===globalVars.tooltipOrientations.left||tooltipOrientation===globalVars.tooltipOrientations.right){p.tailWidth=pInst.settings.canvas.tailHeight;p.tailHeight=pInst.settings.canvas.tailWidth;tooltipPosition[css.top]=-(p.tagBubbleHeight/2);p.totalWidth+=p.tailWidth}if(tooltipOrientation===
globalVars.tooltipOrientations.top){if(p.totalHeight+p.bubbleDotDist>p.tagOffsetTop)tooltipOrientation=globalVars.tooltipOrientations.bottom}else if(tooltipOrientation===globalVars.tooltipOrientations.right){if(p.totalWidth+p.bubbleDotDist>p.tagOffsetRight)tooltipOrientation=globalVars.tooltipOrientations.left}else if(tooltipOrientation===globalVars.tooltipOrientations.bottom){if(p.totalHeight+p.bubbleDotDist>p.tagOffsetBottom)tooltipOrientation=globalVars.tooltipOrientations.top}else if(tooltipOrientation===
globalVars.tooltipOrientations.left)if(p.totalWidth+p.bubbleDotDist>p.tagOffsetLeft)tooltipOrientation=globalVars.tooltipOrientations.right;if(tooltipOrientation===globalVars.tooltipOrientations.top)tooltipPosition[css.bottom]=p.bubbleDotDist;else if(tooltipOrientation===globalVars.tooltipOrientations.right){tooltipPosition[css.left]=p.bubbleDotDist+1;plib.setStyle(elmTagBubbleContent,css.padding.left,10+p.tailWidth)}else if(tooltipOrientation===globalVars.tooltipOrientations.bottom){tooltipPosition[css.top]=
p.bubbleDotDist+1;plib.setStyle(elmTagBubbleContent,css.top,p.totalHeight-p.tagBubbleContentHeight)}else if(tooltipOrientation===globalVars.tooltipOrientations.left){tooltipPosition[css.right]=p.bubbleDotDist;plib.setStyle(elmTagBubbleContent,css.padding.right,10+p.tailWidth)}if(tooltipOrientation===globalVars.tooltipOrientations.top||tooltipOrientation===globalVars.tooltipOrientations.bottom)if(p.tagOffsetLeft<p.tagBubbleWidth/2)tooltipPosition[css.left]=-p.tagOffsetLeft;else if(p.tagOffsetRight<
p.tagBubbleWidth/2)tooltipPosition[css.left]=-(p.tagBubbleWidth-p.tagOffsetRight);plib.setStyles(elmTagBubble,tooltipPosition);plib.setWidth(elmTagBubble,p.totalWidth);plib.setHeight(elmTagBubble,p.totalHeight);plib.runInterval(30,30,function(){return support.canvas},function(){oParameters={};oParameters[attributes.className]=classes.tagBubbleCanvas;canvas=plib.domAppend(html.canvas,elmTagBubble,oParameters);canvas.pinupCanvasProperties={theme:pInst.settings.canvas.theme,allowStroke:pInst.settings.canvas.stroke,
allowShadow:pInst.settings.canvas.shadow,cornerRadius:pInst.settings.canvas.cornerRadius,canvasPadding:p.bubblePadding,halfPixel:p.halfPixel,width:p.tagBubbleWidth,height:p.tagBubbleHeight,offsetLeft:p.tagOffsetLeft,offsetRight:p.tagOffsetRight,pointerWidth:p.tailWidth,pointerHeight:p.tailHeight,orientation:tooltipOrientation};pInst.ui.drawTooltip(canvas,canvas.pinupCanvasProperties)},function(){});return elmTagBubble},drawLinkData:function(oLinks){var pInst=this,elmLinkHolder=pInst.privateElements.linkHolder,
fn_tagLinkMouseover=function(){var strGUID=plib.attribute(this,attributes.tagGuid);if(plib.hasProperty(cacheTags,pInst.uid))if(plib.hasProperty(cacheTags[pInst.uid],strGUID))pInst.tagMouseoverEvent(document.getElementById(tagPrefix+pInst.uid+"-"+cacheTags[pInst.uid][strGUID]))},fn_tagLinkMouseout=function(){plib.loopArray(plib.getElementsByClassName(classes.tag,pInst.privateElements.imgTagHolder),function(value){pInst.tagMouseoutEvent(value)})};plib.removeChildren(elmLinkHolder);plib.loopObject(oLinks,
function(val){plib.loopArray(val,function(value){var elmTagLink,oLinkAttr;oLinkAttr={};oLinkAttr[attributes.className]=classes.link;oLinkAttr[attributes.tagGuid]=value[serverKeys.tags.guid];elmTagLink=plib.domAppend(html.a,elmLinkHolder,oLinkAttr);pfunc.setWindowLink(elmTagLink,directory.paths.webloc+value[serverKeys.tags.guid]);oLinkAttr={};oLinkAttr[attributes.className]=classes.iconLabel;plib.domAppend(html.span,elmTagLink,oLinkAttr);plib.appendText(elmTagLink,value[serverKeys.tags.name]);if(pInst.settings.tooltip){plib.addEvent(elmTagLink,
events.mouseover,fn_tagLinkMouseover);plib.addEvent(elmTagLink,events.mouseout,fn_tagLinkMouseout)}})});if(plib.isElementEmpty(elmLinkHolder)){plib.hide(pInst.privateElements.sectionFooter);plib.hide(elmLinkHolder);plib.setHeight(pInst.privateElements.imgNode,pInst.dimensions.height)}else{plib.show(pInst.privateElements.sectionFooter);plib.show(elmLinkHolder);plib.setHeight(pInst.privateElements.imgNode,plib.getHeight(elmLinkHolder)+pInst.dimensions.height)}},enableImgNode:function(){var pInst=this;
if(pInst.disallowNodeUpdate)return;if(!pInst.settings.alwaysShowTags)plib.addClass(pInst.privateElements.imgNode,classes.actionOn);pfunc.checkLogin(null,null,function(){pfunc.methodSessionChange(pInst)});pfunc.newKeyListener(keyCodes.f2,pInst.uid,function(){pInst.ui.toggle()})},disableImgNode:function(){var pInst=this;if(pInst.disallowNodeUpdate)return;if(!pInst.settings.alwaysShowTags)plib.removeClass(pInst.privateElements.imgNode,classes.actionOn);pfunc.removeKeyListener(keyCodes.f2,pInst.uid)},
resetTagDotBehavior:function(){var pInst=this;plib.loopArray(plib.getElementsByClassName(classes.tagDot,pInst.privateElements.imgTagHolder),function(tagDot){var tagGuidObject=pfunc.getTagGuidObject(tagDot.parentNode),tagGuid=tagGuidObject?plib.hasProperty(tagGuidObject,"tagGUID")?tagGuidObject.tagGUID:plib.hasProperty(tagGuidObject,"tagMultiGUID")?tagGuidObject.tagMultiGUID.split("_")[0]:undefined:undefined;plib.removeAllEvents(tagDot);if(tagGuid)pfunc.setWindowLink(tagDot,directory.paths.webloc+
tagGuid)})},stopTaggingMode:function(){var pInst=this;pInst.disallowNodeUpdate=false;pInst.allowTagBubble=true;plib.removeEvent(pInst.privateElements.imgTagHolder,events.click);plib.removeClass(pInst.privateElements.imgTagHolder,classes.button);pInst.resetTagDotBehavior();pInst.ui.show();pInst.ui.disableCancelMode();plib.removeClass(pInst.privateElements.imgNode,classes.taggingMode);if(!plib.hasClass(globalElements.pInstWrapper,classes.actionShowWin))plib.addClass(pInst.privateElements.imgNode,classes.actionOn)},
startTaggingMode:function(callback){var pInst=this;pfunc.checkPermission(function(){pInst.disallowNodeUpdate=true;pInst.allowTagBubble=false;plib.removeClass(pInst.privateElements.imgNode,classes.actionOn);plib.addClass(pInst.privateElements.imgNode,classes.taggingMode);plib.click(pInst.privateElements.imgTagHolder,function(evt){pInst.stopTaggingMode();if(callback)callback.call(pInst,pfunc.getPosPercentage(evt))},true);plib.loopArray(plib.getElementsByClassName(classes.tagDot,pInst.privateElements.imgTagHolder),
function(value){plib.removeAllEvents(value);plib.click(value,function(){pInst.stopTaggingMode();if(callback)callback.call(pInst,{"x":plib.attribute(this.parentNode,attributes.tagPosX),"y":plib.attribute(this.parentNode,attributes.tagPosY)})},true)});pInst.ui.hide();pInst.ui.enableCancelMode("CANCEL",function(){pInst.stopTaggingMode()})})},stopTagRepositionMode:function(){var pInst=this;pInst.disallowNodeUpdate=false;pInst.allowTagBubble=true;if(plib.hasEvent(document,events.mouseup)){plib.fireEvent(document,
events.mouseup);plib.removeEvent(document,events.mouseup);plib.removeClass(pInst.privateElements.imgNode,classes.handOver)}pInst.resetTagDotBehavior();pInst.ui.show();pInst.ui.disableCancelMode();plib.removeClass(pInst.privateElements.imgNode,classes.repositionMode);plib.addClass(pInst.privateElements.imgNode,classes.actionOn)},startTagRepositionMode:function(){var pInst=this;pfunc.checkPermission(function(){pInst.disallowNodeUpdate=true;pInst.allowTagBubble=false;plib.removeClass(pInst.privateElements.imgNode,
classes.actionOn);plib.addClass(pInst.privateElements.imgNode,classes.repositionMode);plib.loopArray(plib.getElementsByClassName(classes.tag,pInst.privateElements.imgTagHolder),function(value){var tagDot=plib.getElementsByClassName(classes.tagDot,value)[0];plib.removeAllEvents(tagDot);plib.addEvent(tagDot,events.mouseover,function(){plib.addClass(pInst.privateElements.imgNode,classes.handOver)});plib.addEvent(tagDot,events.mouseout,function(){plib.removeClass(pInst.privateElements.imgNode,classes.handOver)});
plib.addEvent(tagDot,events.mousedown,function(event){plib.stopBubble(event);plib.addClass(pInst.privateElements.imgNode,classes.handDrag);pfunc.startDragging(value);plib.addEvent(document,events.mouseup,function(){var parameters=pfunc.getTagGuidObject(tagDot.parentNode);if(parameters){plib.removeClass(pInst.privateElements.imgNode,classes.handDrag);pfunc.stopDragging(value);plib.removeEvent(document,events.mouseup);parameters[serverKeys.tags.imagePath]=pInst.imageSrc;parameters[serverKeys.tags.posX]=
plib.attribute(value,attributes.tagPosX);parameters[serverKeys.tags.posY]=plib.attribute(value,attributes.tagPosY);plib.loadJSONP(directory.names.tagPosition,parameters,pInst.clearTagData)}})})});pInst.ui.hide();pInst.ui.enableCancelMode("DONE",function(){pInst.stopTagRepositionMode()})})},stopTagRemovalMode:function(){var pInst=this;pInst.disallowNodeUpdate=false;pInst.allowTagBubble=true;pInst.resetTagDotBehavior();pInst.ui.show();pInst.ui.disableCancelMode();plib.removeClass(pInst.privateElements.imgNode,
classes.removalMode);plib.addClass(pInst.privateElements.imgNode,classes.actionOn)},startTagRemovalMode:function(){var pInst=this;pfunc.checkPermission(function(){pInst.disallowNodeUpdate=true;pInst.allowTagBubble=false;plib.removeClass(pInst.privateElements.imgNode,classes.actionOn);plib.addClass(pInst.privateElements.imgNode,classes.removalMode);plib.loopArray(plib.getElementsByClassName(classes.tag,pInst.privateElements.imgTagHolder),function(value){var tagDot=plib.getElementsByClassName(classes.tagDot,
value)[0];plib.removeAllEvents(tagDot);plib.click(tagDot,function(event){var tagBubbleContent=plib.getElementsByClassName(classes.tagBubbleContent,tagDot.parentNode)[0],confirmMsg=tagBubbleContent.children.length>1?messages.removeMultiTags:messages.removeTag;pfunc.promptConfirm(confirmMsg,function(){var parameters=pfunc.getTagGuidObject(tagDot.parentNode);if(parameters)plib.loadJSONP(directory.names.tagRemove,parameters,function(data){if(plib.isUndefined(data)){pfunc.closeWindow();plib.removeElement(tagDot.parentNode);
if(settings.allowBottomLinks)if(plib.hasProperty(parameters,"tagGUID"))plib.loopArray(pInst.privateElements.linkHolder.children,function(link){if(plib.attribute(link,attributes.tagGuid)===parameters.tagGUID){plib.removeElement(link);return null}});else if(plib.hasProperty(parameters,"tagMultiGUID"))plib.loopArray(parameters.tagMultiGUID.split("_"),function(guid){plib.loopArray(pInst.privateElements.linkHolder.children,function(link){if(plib.attribute(link,attributes.tagGuid)===guid){plib.removeElement(link);
return null}})});pInst.clearTagData()}})})})});pInst.ui.hide();pInst.ui.enableCancelMode("DONE",function(){pInst.stopTagRemovalMode()})})},manageTagLike:function(btnLike){var pInst=this,elmTag=plib.getParentByClassName(btnLike,classes.tag),elmTagLink=plib.getParentByClassName(btnLike,classes.tagLink),elmTagBubble=plib.getElementsByClassName(classes.tagBubble,elmTag)[0],shareHolder,shareHeader,shareButtons,share_title=plib.attribute(elmTagLink,attributes.tagName),share_url=plib.attribute(elmTagLink,
attributes.tagWebLink),attr;attr={};attr[attributes.className]=classes.shareHolder;shareHolder=plib.newElement(html.div,attr);attr={};attr[attributes.className]=classes.shareHeader;shareHeader=plib.domAppend(html.span,shareHolder,attr,"SHARE THIS ON");attr={};attr[attributes.className]=classes.shareButtons;shareButtons=plib.domAppend(html.div,shareHolder,attr);attr={};attr[attributes.className]=classes.shareButton+whiteSpace+"st_twitter_large";attr[attributes.href]=directory.paths.twitter+plib.getParamsFromObject({"text":share_title+
" found at ","url":encodeURI(share_url)});plib.click(plib.domAppend(html.a,shareButtons,attr),function(){pfunc.openPopupWindow(plib.attribute(this,attributes.href),480,400)});attr={};attr[attributes.className]=classes.shareButton+whiteSpace+"st_facebook_large";attr[attributes.href]=directory.paths.facebook+plib.getParamsFromObject({"u":encodeURI(share_url),"t":encodeURIComponent(share_title)});plib.click(plib.domAppend(html.a,shareButtons,attr),function(){pfunc.openPopupWindow(plib.attribute(this,
attributes.href),1E3,640)});pInst.updateInProgress=true;plib.removeElement(elmTagBubble);elmTagBubble=pInst.drawTagBubble(elmTag,shareHolder);plib.removeEvent(elmTag,events.mouseout);plib.addEvent(elmTag,events.mouseout,function(event){if((new pfunc.MouseBoundaryCrossing(event,this)).leftLandmark){pInst.updateInProgress=false;pInst.updateNode(true)}})}};pfunc={systemStart:function(){var pseudoSEO=document.getElementById(sysName+"SEO"),lazyLoadEvent=function(){clearTimeout(scrollMem);scrollMem=setTimeout(function(){if(!plib.isObjectEmpty(hiddenImages))plib.loopObject(hiddenImages,
function(val){pfunc.loadImage(val.image)});else if(!settings.forceListen){plib.removeEvent(document,support.propertychange);plib.removeEvent(document,events.scroll)}if(settings.forceListen)pfunc.checkForImages()},settings.scrollDelay)};if(alive){pfunc.warn(messages.alreadyAlive);return}alive=true;stats={nImagesFound:0,nImagesLoaded:0,nImagesDenied:0};if(settings.custom&&!plib.isObjectEmpty(settings.custom)&&plib.hasProperty(settings.custom,document.body.id))pfunc.updateSettings(settings.custom[document.body.id]);
pfunc.initKeyListener();pfunc.checkSupport();if(plib.isElement(pseudoSEO))globalElements.pseudoSEO=pseudoSEO;globalElements.pInstActive=plib.newElement(html.div,{"id":classes.docBody,"class":classes.docBody});while(document.body.firstChild)globalElements.pInstActive.appendChild(document.body.firstChild);document.body.appendChild(globalElements.pInstActive);if(!settings.animations)plib.addClass(globalElements.pInstActive,classes.noAnimation);if(!support.rgba)plib.addClass(globalElements.pInstActive,
classes.noRgbaSupport);if(!support.boxShadow)plib.addClass(globalElements.pInstActive,classes.noBoxShadowSupport);if(!support.borderRadius)plib.addClass(globalElements.pInstActive,classes.noBorderRadiusSupport);if(!support.canvas)if(plib.isUndefined(window[oNamespace.vmlCanvas])){pfunc.info(messages.excanvasRequest);plib.loadScript(directory.paths.excanvas,function(){window[oNamespace.vmlCanvas].init_(document);support.canvas=pfunc.getCanvasContext(document.createElement(html.canvas));pfunc.info(messages.excanvasReceived,
support.canvas?"now supported":"still not supported")})}globalElements.pInstWrapper=plib.domAppend(html.div,globalElements.pInstActive,{"class":classes.wrapper});if(settings.allowThemeManager)pfunc.manageTheme(settings.themeFile);globalElements.pInstWindow=plib.domAppend(html.div,globalElements.pInstWrapper,{"class":classes.window});globalElements.pInstWindowOverlay=plib.domAppend(html.div,globalElements.pInstWrapper,{"class":classes.windowOverlay});globalElements.pInstWindowClose=plib.domAppend(html.span,
globalElements.pInstWindow,{"class":classes.windowClose},"close");globalElements.pInstWindowBody=plib.domAppend(html.div,globalElements.pInstWindow,{"class":classes.windowBody});globalElements.pInstWindowBackground=plib.domAppend(html.div,globalElements.pInstWindow,{"class":classes.windowBackground});plib.click(globalElements.pInstWindowOverlay,pfunc.closeWindow);plib.click(globalElements.pInstWindowClose,pfunc.closeWindow);pfunc.checkLogin(null,null,function(){pfunc.checkForImages();if(settings.smartLoad&&
!plib.isObjectEmpty(hiddenImages)||settings.forceListen){plib.addEvent(document,support.propertychange,lazyLoadEvent);plib.addEvent(document,events.scroll,lazyLoadEvent)}if(stats.nImagesLoaded===0)pfunc.info(messages.noImages);if(settings.onReady)settings.onReady.call(window[oNamespace.root]);pfunc.timeEnd(messages.sysLoadTime)})},systemStop:function(){if(!alive){pfunc.warn(messages.alreadyDead);return}alive=false;plib.loopObject(cacheNodes,function(val){val.instance.destroy()});plib.removeElement(globalElements.pInstWrapper);
while(globalElements.pInstActive.hasChildNodes())globalElements.pInstActive.parentNode.insertBefore(globalElements.pInstActive.firstChild,globalElements.pInstActive);plib.removeElement(globalElements.pInstActive);plib.loopObject(cacheEvents,function(val){plib.loopObject(val,function(key,val){plib.removeEvent(val.element,key)})});globalElements={};globalKeyEvents={};cacheImages={};cacheNodes={};cacheTags={};cacheTagData={};cacheEvents={};cacheElements={};queueTagData={};jsonpHandler={};jsonpTimeout=
{};userInfo={};support={};hiddenImages={};stats={};settings=plib.cloneObject(defaultSettings);pfunc.updateWindowNamespace();nLastLoginCheck=0;pfunc.info(messages.sysDestroyed)},updateWindowNamespace:function(ns,object){var fn={},update=function(ns,object){window[oNamespace.root][ns]=object;window[oNamespace.root].prototype[ns]=object};if(ns&&object)update(ns,object);else{update(oNamespace.globalVars,globalVars);update(oNamespace.settings,settings);update(oNamespace.defaultSettings,defaultSettings);
update(oNamespace.user,userInfo);update(oNamespace.json,jsonpHandler);update(oNamespace.lib,plib);plib.loopObject({"systemStart":pfunc.systemStart,"systemStop":pfunc.systemStop,"updateSettings":pfunc.updateSettings,"loadImage":pfunc.loadImage,"unLoadImage":pfunc.unLoadImage,"checkForImages":pfunc.checkForImages,"promptRegister":pfunc.promptRegister,"promptLogin":pfunc.promptLogin,"promptLogout":pfunc.promptLogout,"promptAddTag":pfunc.promptAddTag,"promptSettings":pfunc.promptSettings,"promptOpenLightbox":pfunc.promptOpenLightbox,
"changeTheme":pfunc.changeTheme},function(key,val){fn[key]=val});update(oNamespace.fn,fn);update(oNamespace.images,cacheImages);update(oNamespace.nodes,cacheNodes);update(oNamespace.tags,cacheTags);update(oNamespace.events,cacheEvents);update(oNamespace.elements,cacheElements)}},onImageDimensionReady:function(image,method){function checkReady(){var dimensions={},checkDimensions=function(){dimensions.width=plib.getWidth(image);dimensions.height=plib.getHeight(image);if(dimensions.width!==0&&dimensions.height!==
0)return true;return false};if(checkDimensions()===true)method.call(image,dimensions);else plib.runInterval(10,100,checkDimensions,function(){method.call(image,dimensions)})}if(!image.complete)plib.addEvent(image,events.load,checkReady);else checkReady()},cacheImage:function(image){var uid;if(!image.pinUID){uid=plib.randomID(10);cacheImages[uid]={loaded:false,image:image,offset:plib.getCumulativeOffset(image)};image.pinUID=uid}},checkForImages:function(elmParentNode){function checkParentForImages(parent){plib.loopArray(parent.getElementsByTagName(html.img),
function(image){pfunc.cacheImage(image)})}if(!alive){pfunc.warn(messages.sysNotActive);return}if(settings.loadAll){elmParentNode=elmParentNode||document;if(plib.isElement(elmParentNode)||elmParentNode===document)checkParentForImages(elmParentNode);else if(plib.isArray(elmParentNode))plib.loopArray(elmParentNode,function(element){checkParentForImages(element)})}else{plib.loopArray(plib.getElementsByClassName(settings.activeChildClass),function(image){pfunc.cacheImage(image)});plib.loopArray(plib.getElementsByClassName(settings.activeParentClass),
function(element){plib.loopArray(element.getElementsByTagName(html.img),function(image){pfunc.cacheImage(image)})});if(settings.loadImages.length>0)plib.loopArray(settings.loadImages,function(image){pfunc.cacheImage(image)})}plib.loopObject(cacheImages,function(val){if(!val.loaded)pfunc.loadImage(val.image)});pfunc.info(messages.imageCount,stats.nImagesFound,stats.nImagesLoaded,stats.nImagesDenied)},unLoadImage:function(image,bRemove){bRemove=bRemove||false;pfunc.manageUserInputImage(image,function(pInst){pInst.destroy(bRemove)});
delete cacheImages[image.pinUID]},loadImage:function(image){if(!alive){pfunc.warn(messages.sysNotActive);return}stats.nImagesFound++;pfunc.verifyImageReference(image,function(image){var pInst,imgFileSource=plib.attribute(image,attributes.src),imgFileExt=plib.getFileExtension(imgFileSource),valid=true;if(!image.pinUID)pfunc.cacheImage(image);pInst=plib.hasProperty(hiddenImages,image.pinUID)?hiddenImages[image.pinUID]:new PinInst(image,image.pinUID);if(plib.attribute(image,attributes.imgLoaded)===strBool[1]){pfunc.warn(messages.badInstance);
valid=false}else if(!imgFileSource||plib.stripSpaces(imgFileSource)===""){pfunc.warn(messages.imageNoSrc,image);valid=false}else if(!plib.inArray(settings.allowFile.split("|"),imgFileExt)){pfunc.warn(messages.imageBadFile,imgFileExt,image);valid=false}else if(!plib.isElementIn(image,document)){pfunc.warn(messages.imageNotFound,image);valid=false}else if(globalElements.pseudoSEO&&plib.isElementIn(image,globalElements.pseudoSEO)){pfunc.warn(messages.imageIgnoreSEO,image);valid=false}if(!valid)stats.nImagesDenied++;
else pfunc.onImageDimensionReady(image,function(dimensions){if(dimensions.width<settings.nMinWidth||dimensions.height<settings.nMinHeight){pfunc.warn(messages.imageTooSmall,dimensions.width,settings.nMinWidth,dimensions.height,settings.nMinHeight,this);return}if(settings.smartLoad)if(pfunc.isHidden(this)){hiddenImages[this.pinUID]=pInst;return}else if(plib.hasProperty(hiddenImages,this.pinUID))delete hiddenImages[this.pinUID];stats.nImagesLoaded++;cacheImages[this.pinUID].loaded=true;pfunc.info(messages.imageLoaded,
this);pInst.settings=plib.cloneObject(settings);if(settings.custom&&!plib.isObjectEmpty(settings.custom)&&plib.hasProperty(settings.custom,image.id))pfunc.mergeStrictObjects(pInst.settings,settings.custom[image.id]);delete pInst.settings.custom;pInst.init()})})},mergeStrictObjects:function(masterObject,slaveObject){plib.loopObject(slaveObject,function(key,val){var masterType,slaveType;if(plib.hasProperty(masterObject,key)){masterType=plib.type(masterObject[key]);slaveType=plib.type(val);if(masterType!==
slaveType){pfunc.warn(messages.badType,key,masterType,slaveType);return}if(plib.isObject(val))if(plib.isObjectEmpty(masterObject[key]))masterObject[key]=val;else pfunc.mergeStrictObjects(masterObject[key],val);else masterObject[key]=val}if(!plib.hasProperty(masterObject,key))pfunc.warn(messages.settingDNF,key)})},updateSettings:function(data){pfunc.mergeStrictObjects(settings,data)},initKeyListener:function(){if(settings.keyListener)plib.addEvent(document,events.keyup,function(evt){var keycode=evt.charCode||
evt.keyCode;if(plib.hasProperty(globalKeyEvents,keycode))plib.loopObject(globalKeyEvents[keycode],function(val){val(keycode)})})},newKeyListener:function(key,uid,callback){if(settings.keyListener){if(plib.isElement(uid))uid=plib.getGUID(uid);if(!globalKeyEvents[key])globalKeyEvents[key]={};if(uid)globalKeyEvents[key][uid]=callback}},removeKeyListener:function(key,uid){if(settings.keyListener&&globalKeyEvents[key]){if(plib.isElement(uid))uid=plib.getGUID(uid);if(globalKeyEvents[key][uid])delete globalKeyEvents[key][uid];
if(plib.isObjectEmpty(globalKeyEvents[key]))delete globalKeyEvents[key]}},removeAllKeyListeners:function(uid){if(settings.keyListener)plib.loopObject(globalKeyEvents,function(key,val){if(val[uid])pfunc.removeKeyListener(key,uid)})},centerHorizontal:function(element){var width=plib.getWidth(element),offset="-"+String(width/2)+cssUnit;plib.setStyle(element,css.margin.left,offset)},centerVertical:function(element){var height=plib.getHeight(element),offset="-"+String(height/2)+cssUnit;plib.setStyle(element,
css.margin.top,offset)},openWindow:function(layObject,callback){plib.replaceHTML(globalElements.pInstWindowBody,layObject);plib.addClass(globalElements.pInstWrapper,classes.actionShowWin);pfunc.centerVertical(globalElements.pInstWindow);pfunc.newKeyListener(keyCodes.esc,globalElements.pInstWindow,function(){pfunc.closeWindow()});if(callback)callback.call(globalElements.pInstWindow)},openPrivateWindow:function(layObject,callback){var funcOnSuccess=function(){pfunc.openWindow(layObject,function(){var holder=
plib.getElementsByClassName(classes.windowUserName,this)[0];plib.domAppend(html.span,holder,"Logged in as: ");plib.appendText(holder,userInfo[serverKeys.user.fullName]);plib.click(plib.getElementsByClassName(classes.windowLogout,this)[0],function(){pfunc.closeWindow();pfunc.promptLogout()});if(callback)callback.call(this)})};pfunc.checkLogin(function(){funcOnSuccess()},function(){pfunc.promptLogin(function(){funcOnSuccess()})})},closeWindow:function(){pfunc.removeKeyListener(keyCodes.esc,globalElements.pInstWindow);
plib.removeClass(globalElements.pInstWrapper,classes.actionShowWin);plib.removeChildren(globalElements.pInstWindowBody)},promptConfirm:function(message,callback){pfunc.openWindow(layout.confirmPrompt,function(){var btnAccept=plib.getElementsByClassName(classes.promptAccept,this)[0],btnDeny=plib.getElementsByClassName(classes.promptDeny,this)[0];plib.appendText(plib.getElementsByClassName(classes.promptMessage,this)[0],message);plib.click(btnAccept,function(){pfunc.waitButton(this,messages.formWait);
plib.removeElement(btnDeny);callback()});plib.click(btnDeny,function(){pfunc.closeWindow()})})},setWindowLink:function(element,url,target){target=target||"_self";plib.click(element,function(){var w=window.open(url,target);w.focus()});plib.attribute(element,attributes.href,url)},openPopupWindow:function(url,width,height){var newWindow,docWidth=window.innerWidth||document.documentElement.clientWidth||0,docHeight=window.innerHeight||document.documentElement.clientHeight||0,docLeft=window.screenLeft||
window.screenX||0,docTop=window.screenTop||window.screenY||0,posLeft=docLeft+docWidth/2-width/2,posTop=docTop+docHeight/2-height/2,winopts=[];plib.loopObject({"toolbar":0,"scrollbars":0,"location":1,"statusbar":0,"menubar":0,"resizable":1,"width":width,"height":height,"left":Math.abs(posLeft),"top":Math.abs(posTop)},function(key,val){winopts[winopts.length]=key+"="+val});newWindow=window.open(url,plib.randomID(8),winopts.join(","));if(window.focus)newWindow.focus();return newWindow},updateUserInfo:function(data){if(data===
null)plib.loopObjectKeys(userInfo,function(key){delete userInfo[key]});else plib.mergeObject(userInfo,data)},checkLogin:function(fSuccess,fFailure,fBoth){var time=(new Date).getTime(),timeDiff=time-nLastLoginCheck,postCheckAction=function(data){if(!plib.isObjectEmpty(data)){userLogged=true;if(fSuccess)fSuccess()}else{userLogged=false;if(fFailure)fFailure()}if(fBoth)fBoth()};if(nLastLoginCheck===0||timeDiff>6E4){nLastLoginCheck=time;plib.loadJSONP(directory.names.checkLogin,function(data){pfunc.updateUserInfo(data);
postCheckAction(data)})}else postCheckAction(userInfo)},checkPermission:function(callback){if(!userInfo[serverKeys.user.isOwner])pfunc.openWindow(layout.msgNoPermission);else if(callback)callback()},waitButton:function(element,text){var eventHolder=pfunc.deactivateEvents(element,[events.mouseover,events.mouseout]);if(!plib.isObjectEmpty(eventHolder))element.oEventMemory=eventHolder;if(text){plib.attribute(element,attributes.orgText,plib.textContentRecursive(element));plib.textContentRecursive(element,
text)}},unwaitButton:function(element){plib.textContentRecursive(element,plib.attribute(element,attributes.orgText));plib.attribute(element,attributes.orgText,null);if(element.oEventMemory){pfunc.activateEvents(element,element.oEventMemory);delete element.oEventMemory}},deactivateEvents:function(element,arrEvents){var guid=plib.getGUID(element),eventHolder={};plib.loopArray(arrEvents,function(event){if(cacheEvents[guid]&&cacheEvents[guid][event]){eventHolder[event]=cacheEvents[guid][event].handler;
plib.removeEvent(element,event)}});return eventHolder},activateEvents:function(element,eventHolder){plib.loopObject(eventHolder,function(key,val){plib.addEvent(element,key,val)})},MouseBoundaryCrossing:function(evt,landmark){evt=evt||window.event;var eventType=evt.type,tmpFrom,tmpTo;this.inLandmark=false;this.leftLandmark=false;this.enteredLandmark=false;if(eventType===events.mouseout){this.toElement=evt.relatedTarget||evt.toElement;this.fromElement=evt.target||evt.srcElement}else if(eventType===
events.mouseover){this.toElement=evt.target||evt.srcElement;this.fromElement=evt.relatedTarget||evt.fromElement}if(!this.toElement||!this.fromElement){pfunc.warn(messages.badTarget);return}tmpFrom=this.fromElement;while(plib.isElement(tmpFrom)){if(tmpFrom===landmark)break;tmpFrom=tmpFrom.parentNode}tmpTo=this.toElement;while(plib.isElement(tmpTo)){if(tmpTo===landmark)break;tmpTo=tmpTo.parentNode}if(tmpFrom===landmark&&tmpTo===landmark)this.inLandmark=true;else if(tmpFrom===landmark&&tmpTo!==landmark){this.leftLandmark=
true;this.inLandmark=eventType===events.mouseout}else if(tmpFrom!==landmark&&tmpTo===landmark){this.enteredLandmark=true;this.inLandmark=eventType===events.mouseover}},isHidden:function(element){var pos=plib.getCumulativeOffset(element),nodeWidth=plib.getWidth(element),nodeHeight=plib.getHeight(element),pageOffsetLeft=window.pageXOffset||document.documentElement.scrollLeft,pageOffsetTop=window.pageYOffset||document.documentElement.scrollTop,windowWidth=window.innerWidth||document.documentElement.offsetWidth,
windowHeight=window.innerHeight||document.documentElement.offsetHeight,distXfarLeft,distXfarRight,distYfarTop,distYfarBottom,fixedParent,fixedParentOffset,loopParentsAndSelf=function(element,method){do{if(method(element))break;element=element.offsetParent}while(element)};loopParentsAndSelf(element,function(element){if(plib.getStyle(element,css.position).toLowerCase()==="fixed"){fixedParent=element;return null}});if(fixedParent){fixedParentOffset=plib.getCumulativeOffset(fixedParent);pageOffsetLeft=
fixedParentOffset.x;pageOffsetTop=fixedParentOffset.y}distXfarLeft=pos.x-pageOffsetLeft+nodeWidth<0?true:false;distXfarRight=pos.x>windowWidth+pageOffsetLeft?true:false;distYfarTop=pos.y-pageOffsetTop+nodeHeight<0?true:false;distYfarBottom=pos.y>windowHeight+pageOffsetTop?true:false;if(distXfarLeft||distXfarRight||distYfarTop||distYfarBottom||nodeWidth<0||nodeHeight<0)return true;return!plib.isVisible(element)},getPosPercentage:function(evt){var evTarg=plib.getEventTarget(evt),pos=plib.getMousePosition(evt),
offset=plib.getCumulativeOffset(evTarg),nPosX=((pos.x-offset.x)/plib.getWidth(evTarg)).toFixed(10),nPosY=((pos.y-offset.y)/plib.getHeight(evTarg)).toFixed(10);return{x:nPosX,y:nPosY}},manageKeywords:function(formElement){plib.addEvent(formElement,events.change,function(){var arrKeywords=this.value.replace(regex.ltrim,"").replace(regex.rtrim,"").split(regex.csv);this.value=plib.arrayUnique(arrKeywords).slice(0,10).join(", ").toLowerCase()})},loopFormFields:function(form,callback){plib.loopArray(form.elements,
function(element){var node=element.nodeName.toLowerCase();if(node===html.input||node===html.textarea||node===html.select)return callback.call(element)})},manageFormSubmit:function(form,dir,require,callback,extraValidation){plib.click(plib.getElementsByClassName(classes.formBtnSubmit,form)[0],function(){plib.fireEvent(form,events.submit)});pfunc.loopFormFields(form,function(){plib.addEvent(this,events.focus,function(){plib.addClass(this.parentNode,classes.focus)});plib.addEvent(this,events.blur,function(){plib.removeClass(this.parentNode,
classes.focus)})});pfunc.formFocus(form);pfunc.newKeyListener(keyCodes.enter,form,function(){plib.fireEvent(form,events.submit)});plib.addEvent(form,events.submit,function(evt){var formData,error;plib.stopBubble(evt);formData=pfunc.getFormData(form);if(pfunc.checkRequired(form,require)){if(extraValidation){error=extraValidation.call(form,formData);if(error){pfunc.displayFormError(form,error);return false}}pfunc.disableForm(form);plib.loadJSONP(dir,formData,function(data){pfunc.enableForm(form);callback.call(form,
data)})}})},getFormData:function(form){var data={};plib.loopArray(form.elements,function(element){if(element.value===monetarySymbol||element.value===defaultWebProto)element.value="";if(element.name&&element.value)data[element.name]=element.value});return data},displayFormError:function(elmForm,error){var errorHolder=plib.getElementsByClassName(classes.formError,elmForm)[0];if(error){plib.replaceHTML(errorHolder,error);plib.loopArray(elmForm.getElementsByTagName(html.input),function(element){if(element.type===
types.password)element.value=""});pfunc.formFocus(elmForm)}else plib.removeChildren(errorHolder)},formFocus:function(form){pfunc.loopFormFields(form,function(){if(!this.value){this.focus();return null}})},checkRequired:function(form,require){var n=0,validate=function(element){var label=plib.getParentByClassName(element,classes.formLabel);if(!label)label=plib.getParentByClassName(element,classes.formLabelSm);if(!element.value||element.value===""){n++;if(label)plib.addClass(label,classes.formErrorRow)}else if(label)plib.removeClass(label,
classes.formErrorRow)};if(require.length===1)if(require[0]===asterisk)pfunc.loopFormFields(form,function(){validate(this)});else validate(form.elements[require[0]]);else if(require.length>0)plib.loopArray(require,function(value){validate(form.elements[value])});if(n>0){pfunc.displayFormError(form,messages.missingReqInput);return false}else{pfunc.displayFormError(form,null);return true}},enableFormElement:function(element){plib.attribute(element,attributes.disabled,null);if(element.nodeName.toLowerCase()===
html.input)plib.attribute(element,attributes.readonly,null);return element},disableFormElement:function(element){plib.attribute(element,attributes.disabled,attributes.disabled);if(element.nodeName.toLowerCase()===html.input)plib.attribute(element,attributes.readonly,attributes.readonly);return element},disableForm:function(form){var formBtnSubmit=plib.getElementsByClassName(classes.formBtnSubmit,form)[0];plib.loopArray(form.elements,function(element){pfunc.disableFormElement(element)});if(formBtnSubmit)pfunc.waitButton(formBtnSubmit,
messages.formWait)},enableForm:function(form){var formBtnSubmit=plib.getElementsByClassName(classes.formBtnSubmit,form)[0];plib.loopArray(form.elements,function(element){pfunc.enableFormElement(element)});if(formBtnSubmit)pfunc.unwaitButton(formBtnSubmit)},manageTagSuggestionList:function(form){var dropdown=plib.domAppend(html.div,form,{"class":classes.formDropDownDiv}),elmInputFocus=form.elements[names.strTagName],inputOffset=plib.getCumulativeOffset(elmInputFocus),parentOffset=plib.getCumulativeOffset(dropdown.parentNode),
preventFocusLoss=function(element){plib.addEvent(element,events.mousedown,function(evt){plib.stopBubble(evt)})},updateDropdownList=function(strChars){clearTimeout(dropdown.timeout);if(strChars)dropdown.timeout=setTimeout(function(){plib.removeChildren(dropdown);plib.appendText(dropdown,messages.loading);plib.show(dropdown);plib.loadJSONP(directory.names.getTagSugg,{"strChars":strChars},function(data){plib.removeChildren(dropdown);if(!plib.hasClass(elmInputFocus.parentNode,classes.focus))return;if(data===
null)plib.appendText(dropdown,messages.timeoutError);else if(plib.isUndefined(data))plib.textContent(dropdown,messages.noResults);else plib.loopArray(data,function(value){var link,attr;attr={};attr[attributes.tagWebLink]=value[serverKeys.tags.webLink];attr[attributes.tagKeywords]=value[serverKeys.tags.keywords].join(", ");link=plib.domAppend(html.span,dropdown,attr);attr={};attr[attributes.className]=classes.iconLabel;plib.domAppend(html.span,link,attr);plib.appendText(link,value[serverKeys.tags.name]);
preventFocusLoss(link);plib.click(link,function(){form.elements[names.strTagName].value=plib.textContent(this);form.elements[names.strWebLink].value=plib.attribute(this,attributes.tagWebLink);form.elements[names.strKeywords].value=plib.attribute(this,attributes.tagKeywords);elmInputFocus.blur()},true)})})},300);else{plib.removeChildren(dropdown);plib.hide(dropdown)}};dropdown.style[css.left]=String(inputOffset.x-parentOffset.x-9)+cssUnit;dropdown.style[css.top]=String(inputOffset.y-parentOffset.y+
33)+cssUnit;plib.addEvent(elmInputFocus,events.focus,function(){plib.addClass(this.parentNode,classes.focus);if(this.value)updateDropdownList(this.value)});plib.addEvent(elmInputFocus,events.blur,function(){plib.removeClass(this.parentNode,classes.focus);plib.removeChildren(dropdown);plib.hide(dropdown)});plib.addEvent(elmInputFocus,events.keyup,function(){updateDropdownList(this.value)});plib.hide(dropdown)},currencyFormat:function(num){var sign,cents,addCommas=function(num){var i;num=num.toString();
for(i=0;i<Math.floor((num.length-(1+i))/3);i++)num=num.substring(0,num.length-(4*i+3))+","+num.substring(num.length-(4*i+3));return num},getCents=function(num){num=String(num%100);if(num.length<2)num="0"+num;return num},getSign=function(num){return parseFloat(num)<0?"-":""};num=num.toString().replace(regex.nump,"");num=isNaN(num)?"0":num;sign=getSign(num);num=Math.floor(Math.abs(num)*100+0.50000000001);cents=getCents(num);num=addCommas(Math.floor(num/100));return sign+monetarySymbol+num+"."+cents},
urlFormat:function(url){var purl=plib.parseUrl(url),protos=["http","https"];if(!purl.protocol||!plib.inArray(protos,purl.protocol))url=defaultWebProto+purl.host+purl.relative;return url},validWebUrl:function(formElement){plib.addEvent(formElement,events.change,function(){this.value=pfunc.urlFormat(this.value)});if(formElement.value==="")formElement.value=defaultWebProto;else plib.fireEvent(formElement,events.change)},getCanvasContext:function(canvas,context){if(!plib.isUndefined(window[oNamespace.vmlCanvas]))window[oNamespace.vmlCanvas].initElement(canvas);
if(context)return canvas.getContext(context);else return!!canvas.getContext},getStylePrefixes:function(style){var styles=[plib.camelize(style)];plib.loopArray(["webkit","moz","o","ms","khtml"],function(value){styles[styles.length]=plib.camelize("-"+value+"-"+style)});return styles},checkSupport:function(){var div=document.createElement(html.div),canvas=document.createElement(html.canvas),span,color;div.innerHTML='<span style="float:left;opacity:.55;"></span>';span=div.getElementsByTagName(html.span)[0];
support.cssFloat=!!span.style.cssFloat?"cssFloat":"styleFloat";support.opacity=regex.opacity.test(span.style[css.opacity]);support.propertychange=plib.hasProperty(document,"onpropertychange")?"propertychange":"DOMAttrModified";support.canvas=pfunc.getCanvasContext(canvas);color=div.style.color;pfunc.attempt(function(){div.style.color="rgba(0, 0, 0, 0.5)"});support.rgba=div.style.color!==color;support.boxShadow=false;plib.loopArray(pfunc.getStylePrefixes("box-shadow"),function(value){if(!plib.isUndefined(div.style[value])){support.boxShadow=
true;return null}});support.borderRadius=false;plib.loopArray(pfunc.getStylePrefixes("border-radius"),function(value){if(!plib.isUndefined(div.style[value])){support.borderRadius=true;return null}})},setFluidWidth:function(element){var orgWidth=plib.getWidth(element);plib.setWidth(element,"auto");plib.setStyle(element,css.cssFloat,"left");plib.attribute(element,attributes.fluidWidth,plib.getWidth(element));plib.setWidth(element,orgWidth);plib.setStyle(element,css.cssFloat,"none")},isValidEmail:function(str){var atSym=
str.lastIndexOf("@"),lastDot=str.lastIndexOf(".");if(atSym<1)return false;if(atSym===str.length-1)return false;if(atSym>64)return false;if(str.length-atSym>255)return false;if(lastDot>atSym+1&&lastDot<str.length-1)return true;if(str.charAt(atSym+1)==="["&&str.charAt(str.length-1)==="]")return true;return false},manageBackToLogin:function(parentForm,callback){plib.click(plib.getElementsByClassName(classes.formOption_backToLogin,parentForm)[0],function(){pfunc.promptLogin(callback)})},manageRegistration:function(parentForm,
callback){plib.click(plib.getElementsByClassName(classes.formOption_register,parentForm)[0],function(){pfunc.promptRegister(callback)})},manageForgotPass:function(parentForm,callback){plib.click(plib.getElementsByClassName(classes.formOption_forgotPass,parentForm)[0],function(){pfunc.openWindow(layout.formForgot,function(){var forgotForm=document.forms[names.formForgot];pfunc.manageBackToLogin(forgotForm,callback);pfunc.manageFormSubmit(forgotForm,directory.names.forgot,[asterisk],function(data){if(data)pfunc.displayFormError(this,
data);else{pfunc.openWindow(layout.msgForgot);if(userLogged)pfunc.promptLogout();if(callback)callback()}})})})},promptRegister:function(callback){pfunc.openWindow(layout.formRegister,function(){var registerForm=document.forms[names.formRegister];pfunc.manageBackToLogin(registerForm,callback);registerForm.elements[names.strWebURL].value=plib.parseUrl(windowLocation).host.split(".").slice(-2).join(".");pfunc.validWebUrl(registerForm.elements[names.strWebURL]);pfunc.manageFormSubmit(registerForm,directory.names.register,
[asterisk],function(data){if(plib.isString(data))pfunc.displayFormError(this,data);else if(plib.isUndefined(data)){pfunc.openWindow(layout.msgRegistered);if(callback)callback(data)}},function(formdata){var strEmail=formdata[names.strUsername];if(!pfunc.isValidEmail(strEmail)){this.elements[names.strUsername].value="";return messages.invalidEmail}})})},promptLogin:function(callback){pfunc.openWindow(layout.formLogin,function(){var loginForm=document.forms[names.formLogin];pfunc.manageForgotPass(loginForm,
callback);pfunc.manageRegistration(loginForm,callback);pfunc.manageFormSubmit(loginForm,directory.names.login,[asterisk],function(data){if(plib.isString(data))pfunc.displayFormError(this,data);else if(plib.isObject(data)){userLogged=true;nLastLoginCheck=0;pfunc.updateUserInfo(data);pfunc.methodSessionChange();pfunc.closeWindow();if(settings.onLogin)settings.onLogin.call(window[oNamespace.root],data);if(callback)callback()}},function(formdata){var strEmail=formdata[names.strUsername];if(!pfunc.isValidEmail(strEmail)){this.elements[names.strUsername].value=
"";return messages.invalidEmail}})})},promptLogout:function(){plib.loadJSONP(directory.names.logout);userLogged=false;nLastLoginCheck=0;pfunc.updateUserInfo(null);pfunc.methodSessionChange();if(settings.onLogout)settings.onLogout.call(window[oNamespace.root])},methodSessionChange:function(pInst){var hash=plib.getParamsFromObject(userInfo),action=function(hash){var pInst=this;if(hash!==userHash)pInst.ui.destroy();pInst.updateNode(true);pInst.ui.check()};if(pInst)action.call(pInst,hash);else plib.loopObject(cacheNodes,
function(val){action.call(val.instance,hash)});userHash=hash},findImageByString:function(string){var element,imgById=document.getElementById(string);if(imgById)element=imgById;else plib.loopArray(document.getElementsByTagName(html.img),function(image){if(plib.attribute(image,attributes.src)===string||image.src===string)element=image});return element},verifyImageReference:function(image,callback){if(plib.isString(image))image=pfunc.findImageByString(image);if(!image||!plib.isElement(image)){pfunc.warn(messages.noImage);
return}if(callback)callback(image)},getInstanceByImage:function(image){var guid=plib.getGUID(image),nodeKey;if(guid)plib.loopObject(cacheNodes,function(key,val){if(val.imgGUID===guid)nodeKey=key});return nodeKey?cacheNodes[nodeKey].instance:undefined},manageUserInputImage:function(image,callback){pfunc.verifyImageReference(image,function(image){var pInst=pfunc.getInstanceByImage(image);if(!pInst){pfunc.warn(messages.noInstance);return}if(callback)callback(pInst)})},getTagGuidObject:function(element){var attr=
{tagGUID:plib.attribute(element,attributes.tagGuid)};if(!attr.tagGUID){delete attr.tagGUID;attr.tagMultiGUID=plib.attribute(element,attributes.tagMultiGuid)}if(!attr.tagMultiGUID)delete attr.tagMultiGUID;return plib.isObjectEmpty(attr)?undefined:attr},promptAddTag:function(image){var action=function(){this.startTaggingMode(this.methodAddNewTag)};pfunc.manageUserInputImage(image,function(pInst){pfunc.checkLogin(function(){action.call(pInst)},function(){pfunc.promptLogin(function(){action.call(pInst)})})})},
promptRepositionTags:function(image){pfunc.manageUserInputImage(image,function(pInst){pfunc.checkLogin(function(){pInst.startTagRepositionMode()},function(){pfunc.promptLogin(function(){pInst.startTagRepositionMode()})})})},promptRemoveTags:function(image){pfunc.manageUserInputImage(image,function(pInst){pfunc.checkLogin(function(){pInst.startTagRemovalMode()},function(){pfunc.promptLogin(function(){pInst.startTagRemovalMode()})})})},promptOpenLightbox:function(image){var lightbox,lightboxOverlay,
lightboxWindow,lightboxImageHolder,lightboxShowLeft,lightboxShowRight,maxIndex,index=0,i=0,nodeTracker=[],showImageByIndex=function(index){var child=lightboxImageHolder.children[index],centerLightbox=function(element){plib.show(element);pfunc.centerVertical(lightboxWindow);pfunc.centerHorizontal(lightboxWindow)};plib.loopArray(lightboxImageHolder.children,plib.hide);if(child.nodeName.toLowerCase()==="img")pfunc.onImageDimensionReady(child,function(){centerLightbox(this);pfunc.loadImage(this);nodeTracker.push(cacheNodes[this.pinUID])});
else centerLightbox(child)},showLeftImage=function(){index-=1;if(index<0)index=maxIndex;showImageByIndex(index)},showRightImage=function(){index+=1;if(index>maxIndex)index=0;showImageByIndex(index)},destroyLightbox=function(){plib.loopArray(nodeTracker,function(node){node.instance.destroy()});nodeTracker=[];plib.removeElement(lightbox)},removeExistingLightboxes=function(){var element=plib.getElementsByClassName(classes.lightboxOverlay)[0];if(element)plib.fireEvent(element,"click")};removeExistingLightboxes();
if(!plib.isObjectEmpty(cacheImages)){lightbox=plib.domAppend(html.div,globalElements.pInstActive,{"class":classes.lightbox});lightboxOverlay=plib.domAppend(html.div,lightbox,{"class":classes.lightboxOverlay});lightboxWindow=plib.domAppend(html.div,lightbox,{"class":classes.lightboxWindow});lightboxImageHolder=plib.domAppend(html.div,lightboxWindow,{"class":classes.lightboxImageHolder});lightboxShowLeft=plib.domAppend(html.div,lightboxWindow,{"class":classes.lightboxNav+whiteSpace+classes.lightboxShowLeft});
lightboxShowRight=plib.domAppend(html.div,lightboxWindow,{"class":classes.lightboxNav+whiteSpace+classes.lightboxShowRight});plib.domAppend(html.span,lightboxShowLeft,{"class":classes.lightboxNavIcon});plib.domAppend(html.span,lightboxShowRight,{"class":classes.lightboxNavIcon});plib.click(lightboxOverlay,destroyLightbox);plib.click(lightboxShowLeft,showLeftImage);plib.click(lightboxShowRight,showRightImage);pfunc.newKeyListener(keyCodes.arrowLeft,lightbox,showLeftImage);pfunc.newKeyListener(keyCodes.arrowRight,
lightbox,showRightImage);plib.loopObject(cacheImages,function(key,val){if(key===image.pinUID)index=i;if(val.image.src!==window.location.href){plib.domAppend(html.img,lightboxImageHolder,{"class":classes.lightboxImage,"src":val.image.src});i+=1}});maxIndex=i-1;showImageByIndex(index)}},promptSettings:function(image){pfunc.openPrivateWindow(layout.formSettings,function(){var formSettings=document.forms[names.formSettings];plib.click(formSettings.elements[names.btnRepositionTags],function(){pfunc.promptRepositionTags(image);
pfunc.closeWindow()});plib.click(formSettings.elements[names.btnRemoveTags],function(){pfunc.promptRemoveTags(image);pfunc.closeWindow()});plib.click(formSettings.elements[names.btnOpenLightbox],function(){pfunc.closeWindow();pfunc.promptOpenLightbox(image)});if(cacheTagData[image.src]&&cacheTagData[image.src][1]){plib.show(formSettings.elements[names.btnRepositionTags]);plib.show(formSettings.elements[names.btnRemoveTags])}else{plib.hide(formSettings.elements[names.btnRepositionTags]);plib.hide(formSettings.elements[names.btnRemoveTags])}})},
startDragging:function(element){plib.addEvent(document,events.mousemove,function(evt){var mousePosition=plib.getMousePosition(evt),tagHolderOffset=plib.getCumulativeOffset(element.parentNode),pxPosX=mousePosition.x-tagHolderOffset.x,pxPosY=mousePosition.y-tagHolderOffset.y,holderWidth=plib.getWidth(element.parentNode),holderHeight=plib.getHeight(element.parentNode),tagPosition={},margin=10;if(pxPosX<margin)pxPosX=margin;else if(pxPosX>holderWidth-margin-1)pxPosX=holderWidth-margin-1;if(pxPosY<margin)pxPosY=
margin;else if(pxPosY>holderHeight-margin-1)pxPosY=holderHeight-margin-1;plib.attribute(element,attributes.tagPosX,(pxPosX/holderWidth).toFixed(10));plib.attribute(element,attributes.tagPosY,(pxPosY/holderHeight).toFixed(10));tagPosition[css.left]=pxPosX;tagPosition[css.top]=pxPosY;plib.setStyles(element,tagPosition)})},stopDragging:function(){plib.removeEvent(document,events.mousemove)},getLocalStorage:function(itemKey){var item,itemValue,itemValueType;if(settings.allowLocalStorage&&window.localStorage&&
window.JSON){item=localStorage.getItem(itemKey).split("_");itemValueType=item.shift();itemValue=item.join("_");if(itemValueType===BOOLEAN_TYPE)itemValue=itemValue==="true";else if(itemValueType===NUMBER_TYPE)itemValue=parseFloat(itemValue);else if(itemValueType===DATE_TYPE)itemValue=new Date(itemValue);else if(itemValueType===ARRAY_TYPE||itemValueType===OBJECT_TYPE)itemValue=JSON.parse(itemValue)}return itemValue},setLocalStorage:function(itemKey,itemValue){var itemValueType;if(settings.allowLocalStorage&&
window.localStorage&&window.JSON){itemValueType=plib.type(itemValue);if(itemValueType===NULL_TYPE||itemValueType===UNDEFINED_TYPE||itemValueType===ELEMENT_TYPE||itemValueType===FUNCTION_TYPE)return;else if(itemValueType===BOOLEAN_TYPE||itemValueType===NUMBER_TYPE||itemValueType===DATE_TYPE)itemValue=itemValue.toString();else if(itemValueType===ARRAY_TYPE||itemValueType===OBJECT_TYPE)itemValue=JSON.stringify(itemValue);localStorage.setItem(itemKey,itemValueType+"_"+itemValue)}},manageTheme:function(fileName){var attrLink,
index;if(fileName&&fileName!==""){index=parseInt(fileName.split(".")[0],10);if(plib.getStyle(globalElements.pInstWrapper,css.zIndex)!==index){attrLink={};attrLink[attributes.href]=directory.paths.themes+fileName;attrLink[attributes.rel]="stylesheet";attrLink[attributes.type]=types.csstxt;plib.domAppend(html.link,document.getElementsByTagName(html.head)[0],attrLink)}plib.addClass(globalElements.pInstActive,cssPrefix+index);pfunc.info(messages.themeLoaded,index)}},changeTheme:function(theme){plib.loopObject(cacheNodes,
function(val){val.instance.destroy()});pfunc.manageTheme(theme);pfunc.checkForImages()},log:function(){pfunc.print(arguments,0)},info:function(){pfunc.print(arguments,1)},warn:function(){pfunc.print(arguments,2)},error:function(){pfunc.print(arguments,3)},time:function(){pfunc.print(arguments,4)},timeEnd:function(){pfunc.print(arguments,5)},print:function(data,method){method=consoleMethods[method];if(!plib.isUndefined(consoleObject)&&!plib.isNull(consoleObject)){data=Array.prototype.slice.call(data);
if(plib.isFunction(consoleObject[method]))consoleObject[method].apply(consoleObject,data);else if(plib.isObject(consoleObject[method]))Function.prototype.call.call(consoleObject[method],consoleObject,data)}},attempt:function(method){try{method.call()}catch(e){pfunc.error(sysName+plib.stringFormat(": ({0}) {1}: {2}",[e.number,e.name,e.message]))}}};function Pinup(publicKey,sysParams){if(window===this)return new Pinup(publicKey,sysParams);settings=plib.cloneObject(defaultSettings);if(sysParams)pfunc.updateSettings(sysParams);
pfunc.time(messages.sysLoadTime);pfunc.updateWindowNamespace();plib.onDomReady(function(){var localCheckSite,localCheckSiteNS=oNamespace.checkSite+globalVars.publicKey,fn_sysInitialize=function(data){if(data){pfunc.log(messages.serverSet,data);pfunc.updateSettings(data)}if(sysParams)pfunc.updateSettings(sysParams);pfunc.systemStart()};if(!exist){exist=true;if(publicKey)globalVars.publicKey=publicKey;localCheckSite=pfunc.getLocalStorage(localCheckSiteNS);if(localCheckSite)fn_sysInitialize(localCheckSite);
else if(!plib.isUndefined(globalVars.publicKey))plib.loadJSONP(directory.names.checkSite,{"strWebUrl":window.location.hostname},function(data){if(data!==null){fn_sysInitialize(data);pfunc.setLocalStorage(localCheckSiteNS,data)}});plib.addEvent(window,events.unload,pfunc.systemStop);return}else{pfunc.warn(messages.noPubKey);return}})}window[oNamespace.root]=Pinup})(window);